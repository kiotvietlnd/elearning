<!DOCTYPE html>
<html lang="vi" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KiotViet - Tài liệu Ôn tập KV1</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- AOS -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* Tab Styles */
        .tab-btn {
            padding: 10px 24px;
            font-weight: 600;
            font-size: 0.95rem;
            color: #64748b;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
        }
        .tab-btn:hover { color: #1d4ed8; background-color: #f8fafc; }
        .tab-btn.active {
            color: #1d4ed8;
            border-bottom-color: #1d4ed8;
            background-color: #eff6ff;
        }

        /* Sidebar Styling */
        .sidebar-link {
            display: block; padding: 0.6rem 0.75rem; font-size: 0.875rem;
            font-weight: 500; color: #334155; border-radius: 0.5rem;
            transition: all 0.2s; border-left: 3px solid transparent; margin-bottom: 4px;
        }
        .sidebar-link:hover { color: #1d4ed8; background-color: #f1f5f9; }
        .sidebar-link.active {
            background-color: #eff6ff; color: #1d4ed8;
            border-left-color: #1d4ed8; font-weight: 600;
        }

        .scroll-mt-24 { scroll-margin-top: 8rem; } /* Tăng margin để không bị Header che */
        
        /* Article Item */
        .article-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 16px; border-bottom: 1px dashed #e2e8f0;
            transition: background-color 0.3s;
        }
        .article-item:last-child { border-bottom: none; }
        .article-item:hover { background-color: #f8fafc; }

        /* Highlight Animation */
        @keyframes highlight-pulse {
            0% { background-color: #fef08a; } 
            100% { background-color: transparent; }
        }
        .highlight-result { animation: highlight-pulse 2.5s ease-out; }

        /* Tooltip */
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext {
            visibility: hidden; width: 100px; background-color: #334155; color: #fff;
            text-align: center; border-radius: 4px; padding: 4px 0; position: absolute;
            z-index: 10; bottom: 130%; left: 50%; margin-left: -50px; opacity: 0;
            transition: opacity 0.3s; font-size: 10px;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

        /* Search Dropdown */
        #search-results-dropdown {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid #e2e8f0;
            border-radius: 0.5rem; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            max-height: 400px; overflow-y: auto; z-index: 60;
            margin-top: 0.5rem; display: none;
        }
        .search-result-item {
            padding: 0.75rem 1rem; border-bottom: 1px solid #f1f5f9;
            cursor: pointer; transition: background 0.2s;
        }
        .search-result-item:hover { background-color: #eff6ff; }
        .search-group-badge {
            font-size: 10px; padding: 2px 6px; border-radius: 4px;
            font-weight: 700; text-transform: uppercase; margin-right: 6px;
        }
        .badge-basic { background-color: #dbeafe; color: #1e40af; }
        .badge-advanced { background-color: #fce7f3; color: #9d174d; }
    </style>
</head>
<body id="top" class="text-slate-700 antialiased">

    <!-- Header -->
    <header class="sticky top-0 z-50 bg-white/95 backdrop-blur-md border-b border-slate-200 h-20 shadow-sm">
        <div class="max-w-6xl mx-auto px-4 h-full flex items-center justify-between gap-4">
            <div class="flex items-center gap-3 shrink-0 cursor-pointer" onclick="window.scrollTo(0,0)">
                <img src="https://logo.kiotviet.vn/KiotViet-Logo-Horizontal.svg" alt="Logo" class="h-6">
                <span class="text-slate-300 text-xl">|</span>
                <span class="font-bold text-blue-700 text-sm uppercase hidden sm:block">KV1 Review</span>
            </div>
            
            <!-- Search Container -->
            <div class="flex-1 max-w-xl relative group">
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fa-solid fa-magnifying-glass text-slate-400"></i>
                    </span>
                    <input type="text" id="search-input" autocomplete="off" 
                        placeholder="Tìm kiếm kiến thức (VD: Voucher, Công nợ...)" 
                        class="w-full pl-10 pr-4 py-2.5 rounded-lg border border-slate-200 bg-slate-50 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all shadow-sm">
                    <span id="search-loading" class="absolute inset-y-0 right-0 pr-3 flex items-center hidden">
                        <i class="fa-solid fa-circle-notch fa-spin text-blue-500"></i>
                    </span>
                </div>
                
                <div id="search-count-display" class="absolute -bottom-6 right-0 text-xs font-semibold text-slate-500 hidden"></div>
                <div id="search-results-dropdown" class="custom-scrollbar"></div>
            </div>

            <div class="shrink-0 w-8"></div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6 min-h-[80vh]">
        
        <!-- Tab Navigation -->
        <div class="flex justify-center mb-8 border-b border-slate-200" id="tab-container">
            <button class="tab-btn active" onclick="switchTab(0)">
                <i class="fa-solid fa-graduation-cap mr-2"></i>KIẾN THỨC CƠ BẢN
            </button>
            <button class="tab-btn" onclick="switchTab(1)">
                <i class="fa-solid fa-layer-group mr-2"></i>KIẾN THỨC NÂNG CAO
            </button>
        </div>

        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Sidebar Navigation -->
            <aside class="lg:w-1/4 hidden lg:block">
                <div class="sticky top-28 bg-white rounded-2xl p-4 shadow-sm border border-slate-200 overflow-y-auto max-h-[calc(100vh-140px)] custom-scrollbar">
                    <h3 class="font-bold text-slate-800 mb-3 px-2 text-xs uppercase tracking-wider border-b border-slate-100 pb-2">MỤC LỤC</h3>
                    <nav id="sidebar-content" class="space-y-1">
                        <!-- JS Rendered -->
                    </nav>
                </div>
            </aside>

            <!-- Main Content -->
            <div class="lg:w-3/4 w-full">
                <div id="main-content">
                    <!-- JS Rendered -->
                </div>
            </div>
        </div>
    </main>

    <!-- Scroll Top -->
    <a id="scroll-to-top" href="#top" class="fixed bottom-6 right-6 hidden w-10 h-10 bg-white text-blue-600 border border-slate-200 rounded-full items-center justify-center shadow-lg hover:bg-slate-50 z-50 transition-all cursor-pointer">
        <i class="fas fa-arrow-up"></i>
    </a>

    <!-- Scripts -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        // --- DỮ LIỆU ---
        const kv1Data = [
            {
                groupName: "KIẾN THỨC CƠ BẢN", // Index 0
                sections: [
                    {
                        id: "buoi-1",
                        title: "Buổi 1: Làm quen",
                        desc: "Quy trình khởi tạo & Bán hàng cơ bản",
                        topics: [
                            {
                                title: "Làm quen với KiotViet",
                                icon: "fa-flag-checkered",
                                articles: [
                                    { title: "Khởi tạo gian hàng", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-khoi-tao-gian-hang/khoi-tao-gian-hang/", courseLink: "" },
                                    { title: "Đăng ký tài khoản", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-khoi-tao-gian-hang/dang-ky-tai-khoan/", courseLink: "" },
                                    { title: "Tổng quan các bước làm quen", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-lam-quen-voi-kiotviet/tong-quan-cac-buoc-lam-quen-kiotviet/", courseLink: "" },
                                    { title: "Bước 1 - Thêm mới hàng hóa", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-lam-quen-voi-kiotviet/buoc-1-them-moi-hang-hoa/", courseLink: "https://example.com/course1" }, // Ví dụ có link khóa học
                                    { title: "Bước 2 - Nhập hàng", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-lam-quen-voi-kiotviet/buoc-2-nhap-hang/", courseLink: "" },
                                    { title: "Bước 3 - Bán hàng", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-lam-quen-voi-kiotviet/buoc-3-ban-hang/", courseLink: "" },
                                    { title: "Bước 4 - Trả hàng", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-lam-quen-voi-kiotviet/buoc-4-tra-hang/", courseLink: "" },
                                    { title: "Bước 5 - Quản lý công nợ", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-lam-quen-voi-kiotviet/buoc-5-quan-ly-cong-no/", courseLink: "" },
                                    { title: "Bước 6 - Theo dõi báo cáo", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-lam-quen-voi-kiotviet/buoc-6-theo-doi-bao-cao/", courseLink: "" },
                                    { title: "Tổng quan các nhóm giải pháp", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-lam-quen-voi-kiotviet/tong-quan-cac-nhom-giai-phap-kiotviet/", courseLink: "" }
                                ]
                            }
                        ]
                    },
                    {
                        id: "buoi-2",
                        title: "Buổi 2: FAQ Thường gặp",
                        desc: "Xử lý các tình huống vận hành phổ biến",
                        topics: [
                            {
                                title: "Phân quyền & Hàng hóa",
                                icon: "fa-users-gear",
                                articles: [
                                    { title: "Quản lý người dùng (Phân quyền)", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-thiet-lap/quan-ly-nguoi-dung/", courseLink: "" },
                                    { title: "Thêm mới hàng dịch vụ", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-hang-hoa/hang-dich-vu/", courseLink: "" },
                                    { title: "Tạo bảng giá sỉ", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-hang-hoa/thiet-lap-gia/", courseLink: "" }
                                ]
                            },
                            {
                                title: "Giao dịch (Nhập - Bán - Trả)",
                                icon: "fa-cart-shopping",
                                articles: [
                                    { title: "Nhập hàng sản phẩm mới", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-giao-dich/nhap-hang/", courseLink: "" },
                                    { title: "Thêm dòng, thiết lập giá nhập", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-giao-dich/chi-phi-nhap-hang/", courseLink: "" },
                                    { title: "Giá vốn trung bình", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-bao-cao/tong-quan-bao-cao-tai-chinh/#giavon", courseLink: "" },
                                    { title: "Bán hàng sản phẩm mới", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-ban-hang/ban-hang/", courseLink: "" },
                                    { title: "Tra cứu vị trí", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-tra-cuu-san-pham/tra-cuu-san-pham/", courseLink: "" },
                                    { title: "Lập phiếu thu công nợ", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-so-quy/so-quy#lap-phieu-thu", courseLink: "" },
                                    { title: "Bán hàng khi mất mạng", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-ban-hang/che-do-ban-hang-offline/", courseLink: "" },
                                    { title: "Thiết lập thời gian trả hàng", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-thiet-lap/thiet-lap-cua-hang/#GiaoDich", courseLink: "" },
                                    { title: "Trả hàng nhanh", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-tra-hang/tra-hang/", courseLink: "" }
                                ]
                            },
                            {
                                title: "Đối tác & Kho quỹ",
                                icon: "fa-warehouse",
                                articles: [
                                    { title: "Tạo nhóm khách VIP", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-khach-hang/khach-hang/#ThemNhomKhach", courseLink: "" },
                                    { title: "Tạo phiếu kiểm kho", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-hang-hoa/kiem-kho/", courseLink: "" },
                                    { title: "Sổ quỹ: Tạo phiếu thu - chi", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-so-quy/so-quy", courseLink: "" }
                                ]
                            }
                        ]
                    },
                    {
                        id: "buoi-3",
                        title: "Buổi 3: App & Phần cứng",
                        desc: "Thao tác trên thiết bị di động & Kết nối thiết bị",
                        topics: [
                            {
                                title: "Mobile App KiotViet",
                                icon: "fa-mobile-screen",
                                articles: [
                                    { title: "Thao tác trên Mobile App KiotViet", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-mobile-app-ban-hang/ban-hang/", courseLink: "" }
                                ]
                            },
                            {
                                title: "Phần cứng",
                                icon: "fa-print",
                                articles: [
                                    { title: "Máy POS Android", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-thiet-bi-phan-cung/may-pos-android/", courseLink: "" },
                                    { title: "Máy in hóa đơn", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-thiet-bi-phan-cung/may-in-hoa-don/", courseLink: "" },
                                    { title: "Máy in tem mã", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-thiet-bi-phan-cung/may-in-tem-nhan/", courseLink: "" },
                                    { title: "Máy quét mã vạch", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-thiet-bi-phan-cung/may-quet-ma-vach/", courseLink: "" },
                                    { title: "Màn hiển thị QR", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-thiet-bi-phan-cung/man-hien-thi-qr/", courseLink: "" },
                                    { title: "Ngăn kéo đựng tiền", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-thiet-bi-phan-cung/ngan-keo-dung-tien/", courseLink: "" }
                                ]
                            }
                        ]
                    }
                ]
            },
            {
                groupName: "KIẾN THỨC NÂNG CAO", // Index 1
                sections: [
                    {
                        id: "nang-cao-van-hanh", // Đổi ID để tránh trùng lặp nếu có logic phức tạp
                        title: "Tối ưu Vận hành",
                        desc: "Tính năng chuyên ngành & Nghiệp vụ thu ngân",
                        topics: [
                            {
                                title: "Tính năng theo Chuyên ngành",
                                icon: "fa-industry", // Icon mới phù hợp hơn
                                articles: [
                                    { title: "Ngành Nhà thuốc", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-chuyen-nganh/nganh-nha-thuoc/", courseLink: "" },
                                    { title: "Ngành Vật liệu xây dựng", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-chuyen-nganh/nganh-vat-lieu-xay-dung/", courseLink: "" },
                                    { title: "Ngành Mỹ phẩm", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-chuyen-nganh/nganh-my-pham/", courseLink: "" },
                                    { title: "Ngành Điện thoại", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-chuyen-nganh/nganh-dien-thoai-dien-may/", courseLink: "" },
                                    { title: "Ngành Thời trang", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-chuyen-nganh/nganh-thoi-trang/", courseLink: "" }
                                ]
                            },
                            {
                                title: "Nghiệp vụ Thu ngân",
                                icon: "fa-cash-register", // Icon mới phù hợp hơn
                                articles: [
                                    { title: "Bán hàng", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-ban-hang/ban-hang/", courseLink: "" },
                                    { title: "Trả hàng", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-tra-hang/tra-hang/", courseLink: "" },
                                    { title: "Đặt hàng", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-dat-hang/dat-hang/", courseLink: "" },
                                    { title: "Thanh toán qua QR", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-thanh-toan/thanh-toan-qua-vietqr/", courseLink: "" }
                                ]
                            }
                        ]
                    },
                    {
                        id: "nang-cao-quan-ly",
                        title: "Tối ưu Quản lý",
                        desc: "Quản lý hàng hóa đặc biệt",
                        topics: [
                            {
                                title: "Hàng hóa đặc biệt",
                                icon: "fa-boxes-stacked", // Icon cũ phù hợp
                                articles: [
                                    { title: "Hàng Combo - đóng gói", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-hang-hoa/hang-combo-dong-goi/", courseLink: "" },
                                    { title: "Hàng hóa Lô - HSD", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-hang-hoa/hang-hoa-lo-han-su-dung", courseLink: "" },
                                    { title: "Hàng hóa Serial/IMEI", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-hang-hoa/hang-hoa-serial-imei/", courseLink: "" }
                                ]
                            }
                        ]
                    },
                    {
                        id: "nang-cao-doanh-thu",
                        title: "Thúc đẩy Doanh thu",
                        desc: "Mở rộng kênh bán hàng & Công cụ Marketing",
                        topics: [
                            {
                                title: "Bán hàng đa kênh",
                                icon: "fa-share-nodes",
                                articles: [
                                    { title: "KiotViet Web", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-kiotviet-web/kiotviet-web", courseLink: "" },
                                    { title: "Kết nối Sàn TMĐT", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-san-tmdt/ket-noi-san-tmdt/", courseLink: "" },
                                    { title: "Kết nối Mạng xã hội", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-mang-xa-hoi/ket-noi-facebook/", courseLink: "" } // Dùng link Facebook đại diện
                                ]
                            },
                            {
                                title: "Công cụ Marketing",
                                icon: "fa-bullhorn",
                                articles: [
                                    { title: "Chương trình Khuyến mại", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-khuyen-mai/khuyen-mai/", courseLink: "" },
                                    { title: "Tích điểm", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-tich-diem/tich-diem/", courseLink: "" },
                                    { title: "Voucher", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-voucher/voucher/", courseLink: "" },
                                    { title: "Coupon", guideLink: "https://www.kiotviet.vn/huong-dan-su-dung-kiotviet/retail-coupon/coupon/", courseLink: "" }
                                ]
                            }
                        ]
                    }
                ]
            }
        ];

        // State quản lý Tab hiện tại
        let activeTabGroupIndex = 0; // 0: Cơ bản, 1: Nâng cao

        document.addEventListener('DOMContentLoaded', function () {
            AOS.init({ once: true, duration: 800 });
            
            // Khởi tạo giao diện lần đầu
            renderUI();
            
            // --- XỬ LÝ TÌM KIẾM ---
            setupSearch();

            // Scroll Top
            window.onscroll = () => {
                document.getElementById('scroll-to-top').classList.toggle('hidden', window.scrollY < 300);
                document.getElementById('scroll-to-top').classList.toggle('flex', window.scrollY >= 300);
            };
        });

        // Hàm chuyển Tab
        function switchTab(index) {
            if (activeTabGroupIndex === index) return;
            activeTabGroupIndex = index;
            renderUI();
            // Scroll về đầu nội dung khi chuyển tab
            const container = document.getElementById('main-content');
            window.scrollTo({ top: container.offsetTop - 150, behavior: 'smooth' });
        }

        // Render toàn bộ UI (Sidebar + Content + Tab Active State)
        function renderUI() {
            // 1. Cập nhật trạng thái nút Tab
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach((btn, idx) => {
                if (idx === activeTabGroupIndex) btn.classList.add('active');
                else btn.classList.remove('active');
            });

            // 2. Lấy dữ liệu của nhóm hiện tại
            const currentGroupData = kv1Data[activeTabGroupIndex];
            const sidebar = document.getElementById('sidebar-content');
            const content = document.getElementById('main-content');

            // 3. Render Sidebar
            let sidebarHtml = '';
            currentGroupData.sections.forEach(section => {
                sidebarHtml += `<a href="#${section.id}" class="sidebar-link">${section.title}</a>`;
            });
            sidebar.innerHTML = sidebarHtml;

            // 4. Render Content
            let contentHtml = '';
            currentGroupData.sections.forEach(section => {
                contentHtml += `
                    <div id="${section.id}" class="scroll-mt-24 mb-16" data-aos="fade-up">
                        <div class="flex flex-col gap-1 mb-6 pb-4 border-b border-slate-200">
                            <span class="text-xs font-bold text-blue-600 uppercase tracking-widest">${currentGroupData.groupName}</span>
                            <h2 class="text-3xl font-bold text-slate-800">${section.title}</h2>
                            <p class="text-slate-500">${section.desc}</p>
                        </div>
                        <div class="grid grid-cols-1 gap-6">
                `;

                section.topics.forEach(topic => {
                    const articlesHtml = topic.articles.map(article => `
                        <div class="article-item group/item">
                            <span class="text-sm font-medium text-slate-700">${article.title}</span>
                            <div class="flex items-center gap-2">
                                ${article.guideLink ? 
                                    `<a href="${article.guideLink}" target="_blank" class="px-2 py-1 text-xs font-bold text-blue-600 bg-blue-50 hover:bg-blue-100 rounded border border-blue-200 transition-colors flex items-center gap-1">
                                        <i class="fa-solid fa-book-open"></i> HDSD
                                    </a>` : ''
                                }
                                ${article.courseLink ? 
                                    `<a href="${article.courseLink}" target="_blank" class="px-2 py-1 text-xs font-bold text-white bg-orange-500 hover:bg-orange-600 rounded border border-orange-600 transition-colors flex items-center gap-1">
                                        <i class="fa-solid fa-chalkboard-user"></i> Khóa học
                                    </a>` : 
                                    `<div class="tooltip">
                                        <span class="px-2 py-1 text-xs font-bold text-gray-400 bg-gray-100 rounded border border-gray-200 cursor-not-allowed flex items-center gap-1 opacity-60">
                                            <i class="fa-solid fa-chalkboard-user"></i> Khóa học
                                        </span>
                                        <span class="tooltiptext">Đang cập nhật</span>
                                    </div>`
                                }
                            </div>
                        </div>
                    `).join('');

                    contentHtml += `
                        <div class="topic-card bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-md transition-shadow">
                            <div class="bg-slate-50 p-4 border-b border-slate-100 flex items-center gap-3">
                                <div class="w-8 h-8 rounded bg-white text-blue-600 flex items-center justify-center shadow-sm border border-slate-200">
                                    <i class="fa-solid ${topic.icon}"></i>
                                </div>
                                <h3 class="font-bold text-base text-slate-700">${topic.title}</h3>
                            </div>
                            <div class="flex flex-col">
                                ${articlesHtml}
                            </div>
                        </div>
                    `;
                });
                contentHtml += `</div></div>`;
            });
            content.innerHTML = contentHtml;

            // 5. Khởi tạo lại Scroll Spy
            initScrollSpy();
        }

        function initScrollSpy() {
            // Ngừng quan sát các phần cũ trước khi khởi tạo lại
            if (window.currentObserver) {
                window.currentObserver.disconnect();
            }

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.getAttribute('id');
                        document.querySelectorAll('.sidebar-link').forEach(link => {
                            link.classList.remove('active');
                            if (link.getAttribute('href') === `#${id}`) {
                                link.classList.add('active');
                            }
                        });
                    }
                });
            }, { rootMargin: '-20% 0px -60% 0px' });

            // Quan sát các phần trong tab hiện tại
            kv1Data[activeTabGroupIndex].sections.forEach(section => {
                const element = document.getElementById(section.id);
                if (element) {
                    observer.observe(element);
                }
            });
            window.currentObserver = observer; // Lưu observer để ngắt kết nối sau
        }

        function setupSearch() {
            const searchInput = document.getElementById('search-input');
            const searchDropdown = document.getElementById('search-results-dropdown');
            const searchCountDisplay = document.getElementById('search-count-display');
            const searchLoading = document.getElementById('search-loading');

            function removeVietnameseTones(str) {
                str = str.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g,"a"); 
                str = str.replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g,"e"); 
                str = str.replace(/ì|í|ị|ỉ|ĩ/g,"i"); 
                str = str.replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g,"o"); 
                str = str.replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g,"u"); 
                str = str.replace(/ỳ|ý|ỵ|ỷ|ỹ/g,"y"); 
                str = str.replace(/đ/g,"d");
                str = str.replace(/À|Á|Ạ|Ả|Ã|Â|Ầ|Ấ|Ậ|Ẩ|Ẫ|Ă|Ằ|Ắ|Ặ|Ẳ|Ẵ/g, "A");
                str = str.replace(/È|É|Ẹ|Ẻ|Ẽ|Ê|Ề|Ế|Ệ|Ể|Ễ/g, "E");
                str = str.replace(/Ì|Í|Ị|Ỉ|Ĩ/g, "I");
                str = str.replace(/Ò|Ó|Ọ|Ỏ|Õ|Ô|Ồ|Ố|Ộ|Ổ|Ỗ|Ơ|Ờ|Ớ|Ợ|Ở|Ỡ/g, "O");
                str = str.replace(/Ù|Ú|Ụ|Ủ|Ũ|Ư|Ừ|Ứ|Ự|Ử|Ữ/g, "U");
                str = str.replace(/Ỳ|Ý|Ỵ|Ỷ|Ỹ/g, "Y");
                str = str.replace(/Đ/g, "D");
                return str;
            }

            searchInput.addEventListener('input', function(e) {
                const term = e.target.value;
                const normalizedTerm = removeVietnameseTones(term).toLowerCase();
                
                searchDropdown.innerHTML = '';
                searchDropdown.style.display = 'none';
                searchCountDisplay.classList.add('hidden');
                
                if (term.length === 0) return;

                searchLoading.classList.remove('hidden');

                setTimeout(() => {
                    const matches = [];
                    
                    // Tìm kiếm trên TẤT CẢ các group (cả Cơ bản và Nâng cao)
                    kv1Data.forEach((group, gIndex) => {
                        group.sections.forEach(section => {
                            section.topics.forEach(topic => {
                                topic.articles.forEach(article => {
                                    const titleNormalized = removeVietnameseTones(article.title).toLowerCase();
                                    if (titleNormalized.includes(normalizedTerm)) {
                                        matches.push({
                                            title: article.title,
                                            topic: topic.title,
                                            section: section.title,
                                            groupId: group.groupName, // ID của nhóm (Cơ bản/Nâng cao)
                                            groupIndex: gIndex, // Index của nhóm để chuyển tab
                                            sectionId: section.id // ID của section để scroll
                                        });
                                    }
                                });
                            });
                        });
                    });

                    searchLoading.classList.add('hidden');

                    if (matches.length > 0) {
                        searchCountDisplay.innerText = `Tìm thấy ${matches.length} kết quả`;
                        searchCountDisplay.classList.remove('hidden');
                        
                        matches.forEach(match => {
                            const div = document.createElement('div');
                            div.className = 'search-result-item';
                            const badgeClass = match.groupIndex === 0 ? 'badge-basic' : 'badge-advanced';
                            const badgeText = match.groupIndex === 0 ? 'Cơ bản' : 'Nâng cao';

                            div.innerHTML = `
                                <div class="flex items-center mb-1">
                                    <span class="search-group-badge ${badgeClass}">${badgeText}</span>
                                    <span class="font-medium text-slate-700 text-sm">${match.title}</span>
                                </div>
                                <div class="text-xs text-slate-400 pl-1">${match.section} > ${match.topic}</div>
                            `;
                            
                            div.addEventListener('click', () => {
                                // 1. Nếu kết quả thuộc Tab khác, chuyển Tab trước
                                if (match.groupIndex !== activeTabGroupIndex) {
                                    switchTab(match.groupIndex);
                                    // Đợi 1 chút để DOM render xong mới scroll
                                    setTimeout(() => scrollToArticle(match.title, match.sectionId), 150);
                                } else {
                                    scrollToArticle(match.title, match.sectionId);
                                }
                                searchDropdown.style.display = 'none';
                            });
                            
                            searchDropdown.appendChild(div);
                        });
                        searchDropdown.style.display = 'block';
                    } else {
                        searchCountDisplay.innerText = `Không tìm thấy kết quả nào`;
                        searchCountDisplay.classList.remove('hidden');
                    }
                }, 100);
            });

            // Ẩn dropdown khi click ra ngoài
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchDropdown.contains(e.target)) {
                    searchDropdown.style.display = 'none';
                }
            });
        }

        // Helper: Scroll và Highlight
        function scrollToArticle(title, sectionId) {
            // Đảm bảo section đã được render và có mặt trong DOM
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            // Tìm và highlight bài viết
            const allArticles = document.querySelectorAll('.article-item span');
            for (let span of allArticles) {
                if (span.innerText === title) {
                    const articleRow = span.closest('.article-item');
                    // Ensure it's visible, then highlight
                    setTimeout(() => { // Small delay to ensure scroll happens first
                        articleRow.classList.add('highlight-result');
                        setTimeout(() => articleRow.classList.remove('highlight-result'), 2500);
                    }, 200);
                    break;
                }
            }
        }
    </script>
</body>
</html>
