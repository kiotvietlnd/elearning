<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Learning: Kết nối QLBH & HĐĐT KiotViet - KiotViet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f9ff; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: #93c5fd; border-radius: 3px; }
        
        /* Background */
        .soft-glow-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10; background: linear-gradient(135deg, #ffffff 0%, #e0f2fe 50%, #dcfce7 100%); }
        .soft-glow-background .shape { position: absolute; filter: blur(120px); opacity: 0.6; }
        .soft-glow-background .shape1 { height: 300px; width: 300px; background: #bae6fd; border-radius: 50%; top: -50px; left: -50px; animation: moveInCircle 25s ease-in-out infinite; }
        .soft-glow-background .shape2 { height: 350px; width: 350px; background: #bbf7d0; border-radius: 50%; bottom: -50px; right: -50px; animation: moveVertical 30s ease-in-out infinite; }
        @keyframes moveInCircle { 0% { transform: rotate(0deg); } 50% { transform: rotate(180deg); } 100% { transform: rotate(360deg); } }
        @keyframes moveVertical { 0% { transform: translateY(-20%); } 50% { transform: translateY(20%); } 100% { transform: translateY(-20%); } }

        /* UI Elements */
        .nav-link { transition: all 0.2s ease; border-left: 3px solid transparent; }
        .nav-link:hover { color: #2563eb; background: rgba(255, 255, 255, 0.6); }
        .nav-link.active { color: #1e3a8a; border-left: 3px solid #2563eb; background: #eff6ff; font-weight: 600; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }

        /* Card Flip - Fixed & Improved */
        .perspective-1000 { perspective: 1000px; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
        .card-inner.flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; top: 0; left: 0; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); background-color: white; }
        .card-back { transform: rotateY(180deg); }
        .type-card { transition: all 0.2s ease; }
        .type-card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: #93c5fd; }

        /* Chat */
        .chat-bubble { max-width: 85%; padding: 0.75rem 1rem; border-radius: 1rem; position: relative; font-size: 0.9rem; line-height: 1.5; }
        .chat-bubble-customer { background-color: #f1f5f9; color: #334155; border-bottom-left-radius: 0.25rem; margin-left: 2.5rem; }
        .chat-bubble-consultant { background-color: #eff6ff; color: #1e40af; border-bottom-right-radius: 0.25rem; margin-right: 2.5rem; border: 1px solid #dbeafe; }
        
        /* Mobile Sidebar Overlay */
        #mobile-overlay { transition: opacity 0.3s ease; }
        #sidebar { transition: transform 0.3s ease; }
        .sidebar-open #sidebar { transform: translateX(0); }
        .sidebar-open #mobile-overlay { opacity: 1; pointer-events: auto; }
        .sidebar-closed #sidebar { transform: translateX(-100%); }
        .sidebar-closed #mobile-overlay { opacity: 0; pointer-events: none; }
        @media (min-width: 768px) { .sidebar-closed #sidebar { transform: translateX(0); } }

        /* Certificate */
        .certificate-container { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .watermark { position: absolute; top: 50%; left: 60%; transform: translate(-50%, -50%) rotate(-30deg); font-size: 6rem; font-weight: 900; color: rgba(200, 0, 0, 0.05); pointer-events: none; z-index: 0; }
        [title] { cursor: help; }
        
        /* Custom Animation */
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-700 antialiased h-screen flex flex-col overflow-hidden sidebar-closed" id="app-body">
    <div class="soft-glow-background"><div class="shape shape1"></div><div class="shape shape2"></div></div>

    <!-- Header -->
    <header class="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b border-white/50 h-16 shadow-sm flex-shrink-0">
        <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="md:hidden text-slate-600 hover:text-blue-600 p-1">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
                <a href="https://kiotvietlnd.github.io/elearning/" class="flex items-center gap-2 select-none">
                    <img src="https://logo.kiotviet.vn/KiotViet-Logo-Horizontal.svg" alt="Logo" class="h-6">
                    <span class="hidden sm:inline font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-700 to-green-700 text-base uppercase">E-LEARNING</span>
                </a>
            </div>
            <!-- Right Buttons -->
            <div class="flex items-center gap-2 md:gap-3">
                <a href="https://www.kiotviet.vn/ho-tro" target="_blank" class="hidden md:flex items-center gap-2 text-xs sm:text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded-lg shadow-sm transition-colors">
                    <i class="fa-solid fa-book-open"></i> Kho Tài liệu HDSD
                </a>
                <a href="https://www.youtube.com/@HDSDPhanmemKiotViet" target="_blank" class="hidden md:flex items-center gap-2 text-xs sm:text-sm font-bold text-white bg-red-600 hover:bg-red-700 px-3 py-2 rounded-lg shadow-sm transition-colors">
                    <i class="fa-brands fa-youtube"></i> Kho Video HDSD
                </a>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="flex-1 flex overflow-hidden relative">
        <div id="mobile-overlay" class="fixed inset-0 bg-black/20 z-40 md:hidden" onclick="toggleSidebar()"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="absolute inset-y-0 left-0 z-50 w-72 bg-white/95 backdrop-blur-xl border-r border-white/60 shadow-2xl md:static md:bg-white/60 md:shadow-lg md:rounded-r-2xl flex flex-col transform transition-transform duration-300">
            <div class="p-5 border-b border-slate-100 flex-shrink-0">
                <div class="flex justify-between items-start mb-4 md:hidden">
                     <img src="https://logo.kiotviet.vn/KiotViet-Logo-Horizontal.svg" alt="Logo" class="h-5">
                     <button onclick="toggleSidebar()" class="text-slate-400"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <h2 class="font-black text-blue-800 text-lg leading-tight mb-2 uppercase">Kết nối QLBH & HĐĐT KiotViet</h2>
                <h3 class="font-bold text-blue-900 text-sm uppercase tracking-wider mb-2">MỤC LỤC BÀI HỌC</h3>
                <div class="w-full bg-slate-200 rounded-full h-1.5"><div id="totalProgress" class="bg-gradient-to-r from-blue-500 to-green-500 h-1.5 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                <div class="flex justify-between mt-1 text-[10px] text-slate-500 font-medium"><span id="completedCount">0/16</span><span>Hoàn thành</span></div>
            </div>
            <nav class="flex-1 overflow-y-auto p-3 space-y-1 custom-scrollbar">
                 <button onclick="switchTab('cheatsheet')" id="nav-cheatsheet" class="nav-link w-full text-left px-3 py-3 rounded-lg flex items-center gap-3 active"><i class="fa-solid fa-bolt text-yellow-500 w-5 text-center"></i><span class="font-bold text-sm">Tóm tắt nhanh</span></button>
                 <div class="mt-4 mb-2 px-3 text-xs font-extrabold text-slate-500 uppercase tracking-widest">Flashcards Ôn tập</div>
                 
                 <!-- DYNAMIC TABS PLACEHOLDER -->
                 <div id="dynamic-nav-container"></div>
                 
                 <div class="mt-4 mb-2 px-3 text-xs font-extrabold text-slate-500 uppercase tracking-widest">Tổng kết Kiến thức</div>
                 <button onclick="switchTab('summary')" id="nav-summary" class="nav-link w-full text-left px-3 py-3 rounded-lg flex items-center gap-3"><i class="fa-solid fa-table-columns text-purple-500 w-5 text-center"></i><span class="font-bold text-sm">Bảng so sánh</span></button>
                 <button onclick="switchTab('game')" id="nav-game" class="nav-link w-full text-left px-3 py-3 rounded-lg flex items-center gap-3"><i class="fa-solid fa-gamepad text-orange-500 w-5 text-center"></i><span class="font-bold text-sm">Quiz Game</span></button>
            </nav>
            <div class="p-4 bg-slate-50 border-t border-slate-100 text-center text-[10px] text-slate-400">© KiotViet Learning & Development Department</div>
        </aside>

        <!-- Content Area -->
        <main class="flex-1 overflow-y-auto scroll-smooth p-4 md:p-8" id="contentArea">
            <div class="max-w-5xl mx-auto pb-20" id="lessonContainer">
                <!-- CHEATSHEET CONTENT -->
                <div id="tab-cheatsheet" class="tab-content block animate-fade-in-up">
                    <div class="mb-8 text-center">
                         <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider border border-blue-200">Đào tạo Sản phẩm</span>
                        <h1 class="text-2xl md:text-3xl font-black text-blue-900 mt-4 leading-tight">Hướng dẫn Kết nối Phần mềm Quản lý Bán hàng & Hóa đơn Điện tử</h1>
                        <p class="text-slate-500 mt-2 italic text-sm md:text-base">Giải pháp đồng bộ hóa quy trình bán hàng và xuất hóa đơn trên một nền tảng duy nhất.</p>
                    </div>

                    <!-- 3 Lợi ích cốt lõi -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="bg-white p-5 rounded-xl border border-blue-100 shadow-sm hover:shadow-md transition-shadow">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mb-3 text-blue-600"><i class="fa-solid fa-bolt-lightning text-xl"></i></div>
                            <h3 class="font-bold text-slate-800 mb-1">Xử lý tức thì</h3>
                            <p class="text-sm text-slate-600">Dữ liệu truyền tải ngay lập tức từ máy tính tiền sang hệ thống hóa đơn, xóa bỏ hoàn toàn độ trễ.</p>
                        </div>
                        <div class="bg-white p-5 rounded-xl border border-green-100 shadow-sm hover:shadow-md transition-shadow">
                            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mb-3 text-green-600"><i class="fa-solid fa-clock text-xl"></i></div>
                            <h3 class="font-bold text-slate-800 mb-1">Linh hoạt 24/7</h3>
                            <p class="text-sm text-slate-600">Chủ động phát hành hoặc xử lý sai sót bất cứ lúc nào, kể cả ngoài giờ hành chính.</p>
                        </div>
                        <div class="bg-white p-5 rounded-xl border border-purple-100 shadow-sm hover:shadow-md transition-shadow">
                            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mb-3 text-purple-600"><i class="fa-solid fa-wand-magic-sparkles text-xl"></i></div>
                            <h3 class="font-bold text-slate-800 mb-1">Thao tác tối giản</h3>
                            <p class="text-sm text-slate-600">Quy trình tự động hóa, không yêu cầu ký số thủ công trên từng hóa đơn lẻ.</p>
                        </div>
                    </div>

                    <!-- Quy trình thực hiện Timeline -->
                    <h2 class="text-lg font-bold text-blue-900 mb-4 border-l-4 border-blue-500 pl-3">Quy trình kết nối 4 bước</h2>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm mb-8">
                        <div class="space-y-6 md:space-y-0 md:flex md:justify-between relative">
                            <!-- Line -->
                            <div class="hidden md:block absolute top-1/2 left-0 w-full h-1 bg-slate-100 -z-0 -translate-y-1/2 rounded-full"></div>
                            
                            <!-- Steps -->
                            <div class="relative z-10 flex md:flex-col items-center gap-4 md:text-center md:flex-1">
                                <div class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold text-lg shadow-lg border-4 border-white">1</div>
                                <div class="flex-1 md:w-full">
                                    <h4 class="font-bold text-slate-800">Khởi tạo</h4>
                                    <p class="text-xs text-slate-500 mt-1">Thiết lập > HĐĐT > Chọn NCC KiotViet > Kết nối</p>
                                </div>
                            </div>
                            <div class="relative z-10 flex md:flex-col items-center gap-4 md:text-center md:flex-1">
                                <div class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-lg shadow-lg border-4 border-white">2</div>
                                <div class="flex-1 md:w-full">
                                    <h4 class="font-bold text-slate-800">Định danh</h4>
                                    <p class="text-xs text-slate-500 mt-1">Nhập Mã số thuế (MST) của cửa hàng</p>
                                </div>
                            </div>
                            <div class="relative z-10 flex md:flex-col items-center gap-4 md:text-center md:flex-1">
                                <div class="w-10 h-10 rounded-full bg-blue-400 text-white flex items-center justify-center font-bold text-lg shadow-lg border-4 border-white">3</div>
                                <div class="flex-1 md:w-full">
                                    <h4 class="font-bold text-slate-800">Xác thực</h4>
                                    <p class="text-xs text-slate-500 mt-1">Nhập OTP gửi về SĐT chủ gian hàng</p>
                                </div>
                            </div>
                            <div class="relative z-10 flex md:flex-col items-center gap-4 md:text-center md:flex-1">
                                <div class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center font-bold text-lg shadow-lg border-4 border-white">4</div>
                                <div class="flex-1 md:w-full">
                                    <h4 class="font-bold text-slate-800">Cấu hình</h4>
                                    <p class="text-xs text-slate-500 mt-1">Chọn Mẫu hóa đơn & Tùy chọn tự động</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cảnh báo & Lưu ý -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 flex gap-3">
                            <i class="fa-solid fa-triangle-exclamation text-amber-500 mt-1"></i>
                            <div>
                                <h4 class="font-bold text-amber-800 text-sm uppercase">Lưu ý quan trọng</h4>
                                <ul class="list-disc list-inside text-sm text-slate-700 mt-2 space-y-1">
                                    <li>Mã OTP chỉ có hiệu lực trong <strong>5 phút</strong>.</li>
                                    <li>Nếu chưa có hồ sơ: Nhấn nút <strong>"Tạo hồ sơ"</strong> để đăng ký.</li>
                                </ul>
                            </div>
                        </div>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 flex gap-3">
                            <i class="fa-solid fa-shield-halved text-red-500 mt-1"></i>
                            <div>
                                <h4 class="font-bold text-red-800 text-sm uppercase">An toàn dữ liệu</h4>
                                <p class="text-sm text-slate-700 mt-2">Nếu hệ thống báo MST lệch với Sổ kế toán, <strong>KHÔNG tự ý thao tác</strong>. Vui lòng gọi tổng đài <strong>1900 6522</strong> để được hỗ trợ.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DYNAMIC CONTENT TABS WILL BE INSERTED HERE BY JS -->

                <!-- SUMMARY TAB -->
                <div id="tab-summary" class="tab-content hidden animate-fade-in-up">
                    <h2 class="text-xl font-bold text-blue-900 mb-6 border-l-4 border-blue-500 pl-3">Bảng so sánh "Lầm tưởng" vs "Sự thật"</h2>
                    <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                        <table class="w-full table-fixed border-collapse">
                            <thead>
                                <tr class="bg-slate-100 text-slate-600 text-sm uppercase tracking-wider">
                                    <th class="w-16 py-4 border-r border-slate-200 text-center">#</th>
                                    <th class="w-[45%] py-4 border-r border-slate-200 text-center text-red-600 bg-red-50/50">Lầm tưởng (Sai)</th>
                                    <th class="w-[45%] py-4 text-center text-green-600 bg-green-50/50">Sự thật (Đúng)</th>
                                </tr>
                            </thead>
                            <tbody id="summaryTableBody" class="text-sm"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Game & Certificate -->
                <div id="tab-game" class="tab-content hidden animate-fade-in-up">
                    <div id="game-start" class="text-center py-20 bg-white/60 backdrop-blur rounded-3xl border border-white/50 shadow-xl">
                        <div class="inline-block p-6 rounded-full bg-orange-100 mb-6 animate-bounce"><i class="fa-solid fa-gamepad text-5xl md:text-6xl text-orange-500"></i></div>
                        <h2 class="text-2xl md:text-3xl font-black text-slate-800 mb-4 tracking-tight">Quiz Game</h2>
                        <p class="text-slate-600 mb-6 max-w-lg mx-auto leading-relaxed text-sm md:text-base">Hệ thống sẽ hiển thị ngẫu nhiên các nhận định. Nhiệm vụ của bạn là xác định nó ĐÚNG hay SAI. <br><strong>Đạt 80% số câu để nhận Chứng chỉ.</strong></p>
                        <div class="mb-8 flex justify-center">
                            <input type="text" id="player-name" placeholder="Bạn hãy nhập Thông tin Họ và tên - Phòng ban" class="px-5 py-3 rounded-lg border border-slate-300 w-full max-w-md focus:outline-none focus:ring-2 focus:ring-orange-400 focus:border-transparent text-center font-medium shadow-inner">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 max-w-3xl mx-auto">
                            <button onclick="startGame('standard')" class="bg-white border border-blue-200 text-blue-700 px-4 py-3 rounded-lg font-bold hover:bg-blue-50 transition transform hover:scale-105 shadow-sm text-sm"><div class="text-base mb-1">Tiêu Chuẩn</div><div class="text-xs font-normal text-slate-500">5 Câu hỏi ngẫu nhiên</div></button>
                            <button onclick="startGame('pro')" class="bg-white border border-purple-200 text-purple-700 px-4 py-3 rounded-lg font-bold hover:bg-purple-50 transition transform hover:scale-105 shadow-sm text-sm"><div class="text-base mb-1">Pro</div><div class="text-xs font-normal text-slate-500">10 Câu hỏi ngẫu nhiên</div></button>
                            <button onclick="startGame('promax')" class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-4 py-3 rounded-lg font-bold shadow-lg hover:shadow-orange-200 hover:scale-105 transition transform border-2 border-white/20 text-sm"><div class="text-base mb-1" id="btn-promax-text">Promax (Full)</div><div class="text-xs font-normal text-white/80">Toàn bộ câu hỏi</div></button>
                        </div>
                    </div>

                    <div id="game-playing" class="hidden max-w-3xl mx-auto py-10">
                        <div class="flex justify-between items-center mb-6 px-2">
                            <div class="text-slate-400 font-bold uppercase text-xs tracking-wider">Câu hỏi: <span id="q-progress" class="text-orange-600 text-base">1/16</span></div>
                            <div class="text-xs font-bold bg-white px-3 py-1.5 rounded-full border border-slate-200 shadow-sm text-slate-600">Score: <span id="current-score" class="text-green-600">0</span></div>
                        </div>
                        <div id="game-card" class="bg-white rounded-3xl shadow-xl p-8 md:p-10 min-h-[280px] md:min-h-[320px] flex items-center justify-center text-center border border-slate-100 mb-8 relative overflow-hidden transition-all"><div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 to-purple-400"></div><h3 id="question-text" class="text-xl md:text-3xl font-extrabold text-slate-800 leading-snug">Loading...</h3></div>
                        <div class="grid grid-cols-2 gap-4 md:gap-6">
                            <button onclick="answerGame(true)" class="py-4 md:py-6 rounded-2xl bg-white border-2 border-green-100 hover:border-green-500 hover:bg-green-50 text-green-600 font-bold text-lg md:text-2xl shadow-sm hover:shadow-lg transition-all transform active:scale-95 group"><i class="fa-solid fa-check-circle mb-1 block text-2xl md:text-3xl group-hover:scale-110 transition-transform"></i> ĐÚNG</button>
                            <button onclick="answerGame(false)" class="py-4 md:py-6 rounded-2xl bg-white border-2 border-red-100 hover:border-red-500 hover:bg-red-50 text-red-600 font-bold text-lg md:text-2xl shadow-sm hover:shadow-lg transition-all transform active:scale-95 group"><i class="fa-solid fa-times-circle mb-1 block text-2xl md:text-3xl group-hover:scale-110 transition-transform"></i> SAI</button>
                        </div>
                    </div>
                    
                    <!-- Result Screen -->
                    <div id="game-result" class="hidden flex flex-col items-center">
                        <div id="certificate" class="w-full max-w-4xl aspect-video bg-white shadow-2xl flex overflow-hidden certificate-container mx-auto">
                            <div class="w-1/3 bg-blue-900 flex flex-col items-center justify-center text-white p-6 relative">
                                <div class="mb-6"><i class="fa-solid fa-award text-6xl text-yellow-400"></i></div>
                                <div class="text-center z-10"><p class="uppercase tracking-widest text-[10px] opacity-70 mb-1">Cấp bởi</p><p class="font-bold text-sm leading-tight">KiotViet Learning and Development Department</p></div>
                                <div class="absolute bottom-0 left-0 w-full h-2 bg-green-500"></div><div class="absolute top-0 right-0 w-2 h-full bg-black/10"></div>
                            </div>
                            <div class="w-2/3 p-8 md:p-12 flex flex-col justify-center relative bg-white">
                                <div id="fail-watermark" class="watermark hidden">SAMPLE</div>
                                <h1 class="text-3xl md:text-4xl font-black text-blue-900 uppercase mb-3 font-sans tracking-tight">GIẤY CHỨNG NHẬN</h1>
                                <p class="text-slate-500 italic text-sm mb-6 border-b border-slate-100 pb-4 mt-2">Hoàn thành xuất sắc nội dung Đào tạo Sản phẩm</p>
                                <div class="space-y-1 mb-6"><p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Trao tặng cho:</p><h2 class="text-2xl md:text-3xl font-bold text-blue-700 uppercase leading-tight" id="certificate-name">TÊN HỌC VIÊN</h2></div>
                                <div class="space-y-1 mb-6"><p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Nội dung đào tạo:</p><h3 class="text-xl font-bold text-slate-800 uppercase">Kết nối QLBH & HĐĐT KiotViet</h3></div>
                                <div class="flex justify-between items-end mt-auto pt-4 border-t border-slate-100">
                                    <div><p class="text-[10px] text-slate-400 uppercase font-bold">Ngày hoàn thành</p><p class="text-sm font-medium text-slate-600" id="cert-date">dd/mm/yyyy</p></div>
                                    <div class="text-right"><p class="text-[10px] text-slate-400 uppercase font-bold">Kết quả</p><p class="text-xl font-black text-green-600" id="final-score-cert">100%</p></div>
                                </div>
                            </div>
                        </div>
                        <div id="fail-message-container" class="hidden mt-6 bg-red-50 px-6 py-4 rounded-xl border border-red-100 text-center">
                            <p class="text-red-600 font-bold"><i class="fa-solid fa-triangle-exclamation mr-2"></i>Chưa đạt yêu cầu nhận chứng nhận</p>
                            <p class="text-sm text-slate-600 mt-1">Hãy tham khảo lại nội dung và thử lại nhé!</p>
                        </div>
                        <div class="flex gap-4 mt-8 mb-12">
                            <button onclick="playAgain()" class="bg-white border-2 border-blue-600 text-blue-700 px-6 py-3 rounded-full font-bold shadow-sm hover:bg-blue-50 transition"><i class="fa-solid fa-rotate-right mr-2"></i> Chơi lại</button>
                            <button onclick="switchTab('cheatsheet')" class="bg-white border border-slate-200 text-slate-700 px-6 py-3 rounded-full font-bold shadow hover:bg-slate-50 transition flex items-center gap-2"><i class="fa-solid fa-bolt text-yellow-500"></i> Xem Tóm tắt</button>
                            <button onclick="switchTab('summary')" class="bg-white border border-slate-200 text-slate-700 px-6 py-3 rounded-full font-bold shadow hover:bg-slate-50 transition flex items-center gap-2"><i class="fa-solid fa-table-columns text-purple-500"></i> Xem So sánh</button>
                            <button id="btn-download" onclick="downloadCertificate()" class="bg-blue-600 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-blue-700 transition hidden"><i class="fa-solid fa-download mr-2"></i> Tải chứng nhận</button>
                        </div>
                        <!-- Result Review Table -->
                        <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden w-full">
                            <h3 class="text-xl font-bold text-blue-900 px-6 py-4 bg-slate-50 border-b border-slate-100">Chi tiết kết quả</h3>
                            <table class="min-w-full divide-y divide-slate-100">
                                <thead class="bg-white">
                                    <tr>
                                        <th class="px-6 py-4 text-center text-xs font-bold text-slate-500 uppercase">Câu hỏi</th>
                                        <th class="px-6 py-4 text-center text-xs font-bold text-slate-500 uppercase w-32">Bạn chọn</th>
                                        <th class="px-6 py-4 text-center text-xs font-bold text-slate-500 uppercase w-40">Kết quả</th>
                                    </tr>
                                </thead>
                                <tbody id="review-body" class="bg-white divide-y divide-slate-100 text-sm"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        // DỮ LIỆU CỐT LÕI (16 Câu - 8 Đúng/8 Sai)
        const lessonData = [
            // PHẦN 1: TỔNG QUAN & LỢI ÍCH
            {
                id: 1, tabId: 'section1', tabTitle: 'Phần 1: Tổng quan', isTrue: false,
                questionText: "Nhận định: Muốn xuất hóa đơn điện tử, thu ngân bắt buộc phải đăng nhập vào hai phần mềm riêng biệt để thao tác.",
                wrong: "Phải dùng 2 phần mềm song song, thao tác rời rạc.",
                right: "Dữ liệu được đồng bộ tức thì trên 1 nền tảng duy nhất."
            },
            {
                id: 2, tabId: 'section1', tabTitle: 'Phần 1: Tổng quan', isTrue: true,
                questionText: "Nhận định: Dữ liệu bán hàng được đồng bộ tức thì sang phần mềm HĐĐT KiotViet trên cùng một nền tảng duy nhất.",
                wrong: "Vẫn có độ trễ lớn giữa bán hàng và xuất hóa đơn.",
                right: "Chính xác! Loại bỏ hoàn toàn độ trễ và thao tác thủ công."
            },
            {
                id: 3, tabId: 'section1', tabTitle: 'Phần 1: Tổng quan', isTrue: false,
                questionText: "Nhận định: Người bán bắt buộc phải dùng chữ ký số (Token) để ký thủ công xác nhận cho từng tờ hóa đơn bán lẻ.",
                wrong: "Bắt buộc ký số thủ công cho từng hóa đơn lẻ.",
                right: "Hệ thống tối ưu hóa, không yêu cầu ký số thủ công từng tờ."
            },
            {
                id: 4, tabId: 'section1', tabTitle: 'Phần 1: Tổng quan', isTrue: true,
                questionText: "Nhận định: Việc phát hành từ máy tính tiền được tối ưu hóa, không yêu cầu chữ ký số của người bán trên từng hóa đơn lẻ.",
                wrong: "Vẫn yêu cầu ký số phức tạp.",
                right: "Chính xác! Giảm thiểu thao tác cho thu ngân."
            },

            // PHẦN 2: THAO TÁC KẾT NỐI
            {
                id: 5, tabId: 'section2', tabTitle: 'Phần 2: Thao tác Kết nối', isTrue: false,
                questionText: "Nhận định: Chỉ cần nhập đúng Mã số thuế là hệ thống sẽ tự động kết nối thành công mà không cần xác thực thêm.",
                wrong: "Chỉ cần nhập MST là xong, không cần xác thực.",
                right: "Bắt buộc phải xác thực qua mã OTP gửi về điện thoại chủ."
            },
            {
                id: 6, tabId: 'section2', tabTitle: 'Phần 2: Thao tác Kết nối', isTrue: true,
                questionText: "Nhận định: Việc kết nối bắt buộc phải trải qua bước xác thực bằng mã OTP gửi về số điện thoại chủ gian hàng.",
                wrong: "Xác thực OTP là không cần thiết.",
                right: "Chính xác! OTP đảm bảo tính bảo mật và chính chủ."
            },
            {
                id: 7, tabId: 'section2', tabTitle: 'Phần 2: Thao tác Kết nối', isTrue: false,
                questionText: "Nhận định: Mã OTP xác thực có hiệu lực vĩnh viễn cho đến khi được sử dụng.",
                wrong: "Mã OTP có hiệu lực vĩnh viễn.",
                right: "Mã OTP chỉ có hiệu lực trong vòng 5 phút."
            },
            {
                id: 8, tabId: 'section2', tabTitle: 'Phần 2: Thao tác Kết nối', isTrue: true,
                questionText: "Nhận định: Mã OTP chỉ có hiệu lực trong vòng 5 phút, sau đó cần yêu cầu gửi lại mã mới.",
                wrong: "Mã OTP tồn tại rất lâu.",
                right: "Chính xác! Sau 5 phút mã sẽ hết hạn để bảo mật."
            },

            // PHẦN 3: THIẾT LẬP CẤU HÌNH
            {
                id: 9, tabId: 'section3', tabTitle: 'Phần 3: Thiết lập Cấu hình', isTrue: false,
                questionText: "Nhận định: Tại màn hình cấu hình, việc chọn 'Mẫu hóa đơn' là không bắt buộc, có thể bổ sung sau.",
                wrong: "Mẫu hóa đơn là tùy chọn, không bắt buộc.",
                right: "Mẫu hóa đơn là trường thông tin BẮT BUỘC phải chọn."
            },
            {
                id: 10, tabId: 'section3', tabTitle: 'Phần 3: Thiết lập Cấu hình', isTrue: true,
                questionText: "Nhận định: 'Mẫu hóa đơn' là trường thông tin bắt buộc phải chọn để hoàn tất thiết lập phát hành.",
                wrong: "Có thể bỏ qua bước chọn mẫu.",
                right: "Chính xác! Không thể hoàn tất nếu thiếu mẫu hóa đơn."
            },
            {
                id: 11, tabId: 'section3', tabTitle: 'Phần 3: Thiết lập Cấu hình', isTrue: false,
                questionText: "Nhận định: Hệ thống mặc định sẽ tự động phát hành hóa đơn cho mọi đơn hàng ngay sau khi kết nối thành công.",
                wrong: "Mặc định hệ thống tự động phát hành ngay lập tức.",
                right: "Bạn cần chủ động tích chọn 'Tự động phát hành' nếu muốn."
            },
            {
                id: 12, tabId: 'section3', tabTitle: 'Phần 3: Thiết lập Cấu hình', isTrue: true,
                questionText: "Nhận định: Người dùng cần chủ động tích chọn 'Tự động phát hành hóa đơn...' trong phần cấu hình nếu có nhu cầu sử dụng.",
                wrong: "Hệ thống tự quyết định việc phát hành tự động.",
                right: "Chính xác! Đây là tùy chọn cấu hình theo nhu cầu."
            },

            // PHẦN 4: XỬ LÝ TÌNH HUỐNG
            {
                id: 13, tabId: 'section4', tabTitle: 'Phần 4: Xử lý Tình huống', isTrue: false,
                questionText: "Nhận định: Nếu nhập Mã số thuế mà hệ thống báo 'Chưa có hồ sơ', cửa hàng không thể sử dụng dịch vụ HĐĐT KiotViet.",
                wrong: "Không thể sử dụng nếu chưa có hồ sơ sẵn.",
                right: "Có thể nhấn 'Tạo hồ sơ' để đăng ký ngay trên phần mềm."
            },
            {
                id: 14, tabId: 'section4', tabTitle: 'Phần 4: Xử lý Tình huống', isTrue: true,
                questionText: "Nhận định: Nếu Mã số thuế chưa có hồ sơ, người dùng có thể nhấn nút 'Tạo hồ sơ' và thực hiện đăng ký ngay trên phần mềm.",
                wrong: "Phải ra cơ quan thuế đăng ký thủ công.",
                right: "Chính xác! Quy trình tạo hồ sơ được tích hợp sẵn."
            },
            {
                id: 15, tabId: 'section4', tabTitle: 'Phần 4: Xử lý Tình huống', isTrue: false,
                questionText: "Nhận định: Chủ cửa hàng có thể tự do thay đổi Mã số thuế kết nối bất kỳ lúc nào mà không cần quan tâm đến dữ liệu cũ.",
                wrong: "Thoải mái đổi MST mà không ảnh hưởng dữ liệu.",
                right: "Cần thận trọng nếu dữ liệu gắn với Sổ kế toán của MST cũ."
            },
            {
                id: 16, tabId: 'section4', tabTitle: 'Phần 4: Xử lý Tình huống', isTrue: true,
                questionText: "Nhận định: Nếu hệ thống cảnh báo dữ liệu đang gắn với Sổ kế toán của MST cũ, bạn cần liên hệ tổng đài 1900 6522 thay vì tự ý thao tác.",
                wrong: "Nên tự ý ngắt kết nối và đổi MST ngay.",
                right: "Chính xác! Gọi 1900 6522 để đảm bảo an toàn dữ liệu."
            }
        ];

        // CHAT SCRIPTS (Hội thoại dẫn dắt)
        const chatData = {
            'section1': [
                { role: 'customer', text: "Chị sợ nhất là khách đông, vừa bán hàng vừa lo xuất hóa đơn điện tử thì chậm lắm em ơi." },
                { role: 'consultant', text: "Chị yên tâm, tính năng này đồng bộ tức thì trên cùng một nền tảng. Chị bán hàng xong là hóa đơn được đẩy sang hệ thống HĐĐT ngay, không cần thao tác hai nơi đâu ạ." }
            ],
            'section2': [
                { role: 'customer', text: "Nhà chị có 3 chi nhánh, kết nối một lần là dùng chung hết hả em?" },
                { role: 'consultant', text: "Dạ không, chị cần chọn đúng chi nhánh muốn phát hành để thao tác kết nối. Và lưu ý điện thoại của chị phải ở gần để nhận OTP xác thực nhé." }
            ],
            'section3': [
                { role: 'customer', text: "Kết nối xong rồi, giờ cứ thế bán là nó tự xuất hóa đơn à em?" },
                { role: 'consultant', text: "Chưa đâu ạ. Chị cần chọn 'Mẫu hóa đơn' trước đã. Ngoài ra chị có thể bật tính năng 'Tự động phát hành' nếu muốn hệ thống tự chạy khi đơn thành công." }
            ],
            'section4': [
                { role: 'customer', text: "Ơ sao chị nhập MST của công ty mới mà máy báo lỗi không cho đổi thế này?" },
                { role: 'consultant', text: "Do dữ liệu cũ đang gắn với MST trước đó ạ. Trường hợp lệch dữ liệu Sổ kế toán này chị đừng tự sửa, để em báo tổng đài 1900 6522 hỗ trợ cho an toàn nhé." }
            ]
        };

        // VARIABLES & FUNCTIONS
        let gameQuestions = [], currentIndex = 0, score = 0, playerName = "HỌC VIÊN", completedCards = new Set();
        let userAnswers = [];
        let isNavRendered = false;

        function toggleSidebar() { document.body.classList.toggle('sidebar-closed'); document.body.classList.toggle('sidebar-open'); }
        
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-' + tabId).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(el => { el.classList.remove('active', 'bg-blue-50', 'text-blue-900', 'border-blue-600'); el.classList.add('text-slate-700'); });
            const btn = document.getElementById('nav-' + tabId); if(btn) { btn.classList.add('active'); btn.classList.remove('text-slate-700'); }
            if(window.innerWidth < 768) { document.body.classList.add('sidebar-closed'); document.body.classList.remove('sidebar-open'); }
            document.getElementById('contentArea').scrollTop = 0;
            if(tabId === 'summary') renderSummary();
        }

        function renderNav() {
             if (isNavRendered) return;
             
             // Extract unique tabs
             const tabs = [...new Set(lessonData.map(item => item.tabId))];
             const container = document.getElementById('dynamic-nav-container');
             
             tabs.forEach(tabId => {
                 const sampleItem = lessonData.find(i => i.tabId === tabId);
                 const btn = document.createElement('button');
                 btn.onclick = () => switchTab(tabId);
                 btn.id = 'nav-' + tabId;
                 btn.className = 'nav-link w-full text-left px-3 py-3 rounded-lg flex items-center gap-3 text-slate-700';
                 btn.innerHTML = `<i class="fa-solid fa-book-open text-blue-400 w-5 text-center"></i><span class="font-bold text-sm truncate">${sampleItem.tabTitle}</span>`;
                 container.appendChild(btn);
             });

             document.getElementById('btn-promax-text').innerText = `Promax (${lessonData.length} câu)`;
             isNavRendered = true;
        }

        function renderCards() {
            const tabs = [...new Set(lessonData.map(item => item.tabId))];
            const mainContainer = document.getElementById('lessonContainer');
            const summaryTab = document.getElementById('tab-summary');

            tabs.forEach(tabId => {
                const sectionItems = lessonData.filter(i => i.tabId === tabId);
                const sectionTitle = sectionItems[0].tabTitle;
                
                // Create Tab Content Div
                const tabDiv = document.createElement('div');
                tabDiv.id = 'tab-' + tabId;
                tabDiv.className = 'tab-content hidden animate-fade-in-up';
                
                // 1. Render Chat
                let chatHTML = '';
                if(chatData[tabId]) {
                    chatHTML = `<div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 mb-6"><h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 border-b border-slate-50 pb-2">Tình huống dẫn nhập</h3><div class="space-y-4">`;
                    chatData[tabId].forEach(msg => {
                        const bubbleClass = msg.role === 'customer' ? 'chat-bubble-customer' : 'chat-bubble-consultant';
                        const icon = msg.role === 'customer' ? '<div class="absolute bottom-0 -left-10 w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center border border-white shadow-sm"><i class="fa-solid fa-user text-slate-500 text-xs"></i></div>' : '<div class="absolute bottom-0 -right-10 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center border border-white shadow-sm"><img src="https://logo.kiotviet.vn/KiotViet-Logo-Icon.png" class="w-5"></div>';
                        chatHTML += `<div class="relative flex ${msg.role === 'customer' ? 'justify-start' : 'justify-end'}">${msg.role === 'customer' ? icon : ''}<div class="chat-bubble ${bubbleClass}">${msg.text}</div>${msg.role === 'consultant' ? icon : ''}</div>`;
                    });
                    chatHTML += `</div></div>`;
                }

                // 2. Render Cards Grid
                let cardsHTML = `<h2 class="text-xl font-bold text-blue-900 mb-4 flex items-center gap-2"><i class="fa-solid fa-layer-group text-blue-500"></i> ${sectionTitle}</h2>${chatHTML}<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">`;
                
                sectionItems.forEach(item => {
                    cardsHTML += `
                        <div class="type-card h-64 w-full perspective-1000" id="card-container-${item.id}">
                            <div class="card-inner relative w-full h-full">
                                <!-- Front Face -->
                                <div class="card-face p-6 flex flex-col items-center justify-center text-center border border-slate-100">
                                    <div class="w-12 h-12 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center mb-4 text-xl"><i class="fa-solid fa-question"></i></div>
                                    <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-2">Nhận định</h3>
                                    <p class="text-slate-800 font-medium text-lg leading-snug">"${item.questionText}"</p>
                                    <div class="mt-6 flex gap-3 w-full px-4">
                                        <button onclick="flipCard(${item.id}, true)" class="flex-1 py-2 rounded-lg border-2 border-green-100 text-green-600 font-bold hover:bg-green-50 transition text-sm">ĐÚNG</button>
                                        <button onclick="flipCard(${item.id}, false)" class="flex-1 py-2 rounded-lg border-2 border-red-100 text-red-600 font-bold hover:bg-red-50 transition text-sm">SAI</button>
                                    </div>
                                </div>
                                <!-- Back Face (Empty initially) -->
                                <div class="card-face card-back"></div>
                            </div>
                        </div>
                    `;
                });
                cardsHTML += `</div>`;
                
                tabDiv.innerHTML = cardsHTML;
                
                // Insert BEFORE Summary Tab
                mainContainer.insertBefore(tabDiv, summaryTab);
            });
        }

        function renderSummary() {
            const tbody = document.getElementById('summaryTableBody');
            tbody.innerHTML = lessonData.map((item, idx) => `
                <tr class="hover:bg-slate-50 border-b border-slate-50 last:border-0">
                    <td class="px-4 py-3 text-slate-400 font-bold text-center align-top">${idx+1}</td>
                    <td class="px-4 py-3 text-slate-600 bg-red-50/30 border-r border-slate-100 align-top">
                        <div class="flex gap-2"><i class="fa-solid fa-xmark text-red-500 mt-1 flex-shrink-0"></i><span>${item.wrong}</span></div>
                    </td>
                    <td class="px-4 py-3 text-slate-800 bg-green-50/30 align-top font-medium">
                        <div class="flex gap-2"><i class="fa-solid fa-check text-green-500 mt-1 flex-shrink-0"></i><span>${item.right}</span></div>
                    </td>
                </tr>
            `).join('');
        }

        function flipCard(id, choice) {
            const container = document.getElementById(`card-container-${id}`);
            const inner = container.querySelector('.card-inner');
            const backFace = container.querySelector('.card-back');
            const item = lessonData.find(i => i.id === id);
            
            // Check Correctness
            const isCorrect = (choice === item.isTrue);
            
            // UI Content
            const resultHeader = isCorrect 
                ? '<div class="mb-2 font-bold text-lg text-green-600"><i class="fa-solid fa-check-circle mr-1"></i> Chính xác!</div>' 
                : '<div class="mb-2 font-bold text-lg text-red-600"><i class="fa-solid fa-times-circle mr-1"></i> Chưa chính xác!</div>';
            
            const badgeClass = item.isTrue ? 'bg-green-100 text-green-700 border-green-200' : 'bg-red-100 text-red-700 border-red-200';
            const badgeText = item.isTrue ? 'SỰ THẬT (ĐÚNG)' : 'LẦM TƯỞNG (SAI)';
            const backBorderClass = isCorrect ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50';

            backFace.className = `card-face card-back p-5 border-2 flex flex-col justify-center rounded-2xl text-center ${backBorderClass}`;
            backFace.innerHTML = `
                <div class="flex flex-col h-full overflow-y-auto custom-scrollbar">
                    ${resultHeader}
                    <div class="mb-3"><span class="px-3 py-1 rounded-full text-[10px] font-bold border uppercase tracking-wider ${badgeClass}">${badgeText}</span></div>
                    
                    <div class="text-[10px] text-slate-400 uppercase tracking-widest mb-1 font-bold">Nhận định ban đầu</div>
                    <p class="text-slate-600 font-medium text-xs mb-4 italic px-2 line-clamp-2">"${item.questionText}"</p>
                    
                    <div class="bg-white p-3 rounded-lg border border-blue-100 shadow-sm text-left flex-1 flex flex-col justify-center">
                        <p class="text-xs text-blue-600 font-bold uppercase mb-1"><i class="fa-solid fa-lightbulb mr-1"></i>Sự thật là:</p>
                        <p class="text-slate-800 text-sm font-semibold leading-relaxed">${item.right}</p>
                    </div>
                    <button onclick="resetCard(${item.id})" class="mt-3 text-xs text-slate-400 underline hover:text-blue-600 font-medium">Xem lại câu hỏi</button>
                </div>`;
            
            inner.classList.add('flipped');
            if (!completedCards.has(id)) { completedCards.add(id); updateProgress(); }
        }

        function resetCard(id) { document.getElementById(`card-container-${id}`).querySelector('.card-inner').classList.remove('flipped'); }
        function updateProgress() { 
            const pct = (completedCards.size / lessonData.length) * 100;
            document.getElementById('totalProgress').style.width = `${pct}%`; 
            document.getElementById('completedCount').innerText = `${completedCards.size}/${lessonData.length}`; 
        }

        // GAME LOGIC
        function startGame(mode) {
            const nameInput = document.getElementById('player-name').value.trim();
            if (!nameInput) { alert("Vui lòng nhập tên của bạn!"); return; }
            playerName = nameInput;

            score = 0; currentIndex = 0; userAnswers = [];
            
            // Randomize Questions based on mode
            let shuffled = [...lessonData].sort(() => 0.5 - Math.random());
            if (mode === 'standard') gameQuestions = shuffled.slice(0, 5);
            else if (mode === 'pro') gameQuestions = shuffled.slice(0, 10);
            else gameQuestions = shuffled;

            document.getElementById('game-start').classList.add('hidden');
            document.getElementById('game-playing').classList.remove('hidden');
            document.getElementById('game-result').classList.add('hidden');
            loadGameQuestion();
        }

        function loadGameQuestion() {
            const q = gameQuestions[currentIndex];
            document.getElementById('question-text').innerText = q.questionText;
            document.getElementById('q-progress').innerText = `${currentIndex + 1}/${gameQuestions.length}`;
            
            // Animation reset
            const card = document.getElementById('game-card');
            card.classList.remove('animate-fade-in-up');
            void card.offsetWidth; // trigger reflow
            card.classList.add('animate-fade-in-up');
        }

        function answerGame(choice) {
            const q = gameQuestions[currentIndex];
            const isCorrect = (choice === q.isTrue);
            
            if (isCorrect) score++;
            document.getElementById('current-score').innerText = score;

            userAnswers.push({
                question: q.questionText,
                userChoice: choice,
                isUserCorrect: isCorrect
            });

            currentIndex++;
            if (currentIndex < gameQuestions.length) {
                loadGameQuestion();
            } else {
                endGame();
            }
        }

        function endGame() {
            document.getElementById('game-playing').classList.add('hidden');
            document.getElementById('game-result').classList.remove('hidden');
            document.getElementById('certificate-name').innerText = playerName.toUpperCase();
            
            const total = gameQuestions.length;
            const percent = Math.round((score / total) * 100);
            const passThreshold = Math.ceil(total * 0.8);
            const isPass = score >= passThreshold;

            const tbody = document.getElementById('review-body');
            let html = '';
            userAnswers.forEach((ans, idx) => {
                const userBadge = ans.userChoice 
                    ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">ĐÚNG</span>' 
                    : '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">SAI</span>';
                
                const resultText = ans.isUserCorrect
                    ? '<span class="font-bold text-slate-900 flex items-center gap-1 justify-center"><i class="fa-solid fa-check text-green-500"></i> Chính xác</span>'
                    : '<span class="font-bold text-slate-400 flex items-center gap-1 justify-center"><i class="fa-solid fa-xmark text-red-400"></i> Sai rồi</span>';
                
                const rowClass = ans.isUserCorrect ? 'bg-white' : 'bg-red-50/50';

                html += `
                    <tr class="${rowClass} border-b border-slate-50 last:border-0">
                        <td class="px-6 py-4 text-slate-700 font-medium text-left">
                            <span class="text-xs text-slate-400 mr-2">#${idx+1}</span> ${ans.question}
                        </td>
                        <td class="px-6 py-4 text-center whitespace-nowrap">${userBadge}</td>
                        <td class="px-6 py-4 text-center whitespace-nowrap">${resultText}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;

            // Updates
            const certElement = document.getElementById('certificate');
            const certScore = document.getElementById('final-score-cert');
            const certDate = document.getElementById('cert-date');
            const watermark = document.getElementById('fail-watermark');
            const failMsgContainer = document.getElementById('fail-message-container');
            const downloadBtn = document.getElementById('btn-download');

            certScore.innerText = `${percent}% (${score}/${total})`;
            const today = new Date();
            certDate.innerText = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;

            if (isPass) {
                certElement.classList.remove('grayscale');
                failMsgContainer.classList.add('hidden');
                downloadBtn.classList.remove('hidden');
                watermark.classList.add('hidden');
                confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
            } else {
                certElement.classList.add('grayscale');
                failMsgContainer.classList.remove('hidden');
                downloadBtn.classList.add('hidden');
                watermark.classList.remove('hidden');
            }
        }

        function playAgain() {
            document.getElementById('game-result').classList.add('hidden');
            document.getElementById('game-start').classList.remove('hidden');
            document.getElementById('player-name').value = '';
        }

        function downloadCertificate() {
            const certNode = document.getElementById('certificate');
            html2canvas(certNode, { scale: 2, useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                link.download = `ChungNhan_${playerName.replace(/\s+/g, '_')}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        // INIT
        window.onload = function() { 
            renderNav(); 
            switchTab('cheatsheet'); 
            renderCards(); 
        }
    </script>
</body>
</html>
