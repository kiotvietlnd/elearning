<!DOCTYPE html>
<html lang="vi" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ tính thuế kê khai 2026 (Beta) - KiotViet</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- AOS -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fef2f2; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #fee2e2; }
        ::-webkit-scrollbar-thumb { background: #f87171; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #dc2626; }
        .soft-glow-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10; background: linear-gradient(to bottom right, #fef2f2, #fff1f2); }
        .soft-glow-background .shape { position: absolute; filter: blur(120px); opacity: 0.3; }
        .shape1 { background: #ef4444; width: 400px; height: 400px; top: -100px; left: -100px; border-radius: 50%; animation: float 20s infinite; }
        .shape2 { background: #fca5a5; width: 300px; height: 300px; bottom: 0; right: 0; border-radius: 50%; animation: float 25s infinite reverse; }
        @keyframes float { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(20px, 40px); } }
        .toc-link.active { color: #dc2626; border-left: 3px solid #dc2626; background: #fee2e2; font-weight: 600; }
        .tax-table th { background-color: #fee2e2; color: #991b1b; padding: 12px; text-align: left; font-weight: 700; border-bottom: 2px solid #fca5a5; }
        .tax-table td { padding: 12px; border-bottom: 1px solid #fee2e2; vertical-align: top; }
        .tax-table tr:nth-child(even) { background-color: #fef2f2; }
        .tax-table { width: 100%; border-collapse: separate; border-spacing: 0; border-radius: 8px; overflow: hidden; border: 1px solid #fecaca; font-size: 0.95rem; }
        
        /* Input styling for calculator */
        .calc-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            outline: none;
            transition: all 0.2s;
        }
        .calc-input:focus {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }
        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #ef4444;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #ef4444;
        }
        .formula-box {
            font-family: 'Courier New', Courier, monospace;
            background-color: #f8fafc;
            border: 1px dashed #cbd5e1;
            padding: 8px;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #475569;
            margin-top: 4px;
        }
    </style>
</head>
<body class="text-slate-700 antialiased">
    <div class="soft-glow-background"><div class="shape shape1"></div><div class="shape shape2"></div></div>
    
    <!-- Header -->
    <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-red-100 h-16">
        <div class="max-w-6xl mx-auto px-4 h-full flex items-center justify-between">
            <a href="https://kiotvietlnd.github.io/elearning/" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
                <img src="https://logo.kiotviet.vn/KiotViet-Logo-Horizontal.svg" alt="Logo" class="h-6">
                <span class="text-slate-300 text-xl font-light">|</span>
                <span class="font-bold text-blue-700 uppercase text-sm">E-Learning</span>
            </a>
            <a href="https://kiotvietlnd.github.io/elearning/thuehkd" class="text-sm font-bold text-red-600 hover:text-red-800 flex items-center gap-2 transition-colors">
                <i class="fa-solid fa-arrow-left"></i> Quay lại Cẩm nang Thuế HKD
            </a>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8 flex flex-col lg:flex-row gap-10">
        <!-- Sidebar TOC -->
        <aside class="lg:w-1/4 hidden lg:block">
            <div class="sticky top-24 bg-white/80 backdrop-blur p-5 rounded-2xl shadow-sm border border-red-100">
                <h3 class="font-bold text-slate-800 mb-4 uppercase text-xs tracking-wider">Mục lục</h3>
                <nav class="space-y-1" id="toc">
                    <a href="#cong-cu-tinh" class="toc-link block px-3 py-2 text-sm text-slate-600 hover:text-red-600 rounded-r-lg transition-all border-l-2 border-transparent">1. Công cụ tính thuế (Beta)</a>
                    <a href="#tong-quan" class="toc-link block px-3 py-2 text-sm text-slate-600 hover:text-red-600 rounded-r-lg transition-all border-l-2 border-transparent">2. Tổng quan lộ trình</a>
                    <a href="#phan-nhom" class="toc-link block px-3 py-2 text-sm text-slate-600 hover:text-red-600 rounded-r-lg transition-all border-l-2 border-transparent">3. Phân nhóm & Miễn thuế</a>
                    <a href="#huong-dan-tinh-thue" class="toc-link block px-3 py-2 text-sm text-slate-600 hover:text-red-600 rounded-r-lg transition-all border-l-2 border-transparent">4. Hướng dẫn chi tiết</a>
                    <a href="#hoa-don-so-sach" class="toc-link block px-3 py-2 text-sm text-slate-600 hover:text-red-600 rounded-r-lg transition-all border-l-2 border-transparent">5. Hóa đơn & Sổ sách</a>
                    <a href="#rui-ro" class="toc-link block px-3 py-2 text-sm text-slate-600 hover:text-red-600 rounded-r-lg transition-all border-l-2 border-transparent">6. Rủi ro pháp lý</a>
                </nav>
            </div>
        </aside>

        <!-- Content Area -->
        <article class="lg:w-3/4 w-full space-y-10 pb-10">
            <div class="text-center lg:text-left">
                <span class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider">Tiện ích mới</span>
                <h1 class="text-3xl md:text-4xl font-black text-slate-900 mt-4 mb-4 leading-tight">Công cụ tính thuế kê khai 2026 (Beta)</h1>
                <p class="text-slate-500 italic text-sm">Cập nhật lần cuối: 30/12/2025 bởi <strong>LND Department</strong></p>
            </div>

            <p class="leading-relaxed text-slate-700">
                Sử dụng công cụ dưới đây để ước tính số thuế phải nộp theo quy định mới áp dụng từ 01/01/2026. Công cụ hỗ trợ cả hai phương pháp tính: theo tỷ lệ doanh thu (không xác định chi phí) và theo lợi nhuận thực tế (xác định được chi phí).
            </p>

            <!-- SECTION 1: CALCULATOR TOOL -->
            <section id="cong-cu-tinh" class="scroll-mt-24" data-aos="fade-up">
                <div class="bg-white rounded-2xl shadow-xl border border-red-100 overflow-hidden">
                    <div class="bg-red-600 px-6 py-4 text-white flex justify-between items-center">
                        <h2 class="font-bold text-lg"><i class="fa-solid fa-calculator mr-2"></i> Tính Thuế HKD 2026</h2>
                        <span class="bg-white/20 px-2 py-1 rounded text-xs font-medium">BETA</span>
                    </div>
                    
                    <div class="p-6 grid md:grid-cols-2 gap-8">
                        <!-- Input Area -->
                        <div class="space-y-5">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Doanh thu ước tính (năm)</label>
                                <div class="relative">
                                    <input type="text" id="revenueInput" class="calc-input pr-12 font-bold text-slate-800" placeholder="Ví dụ: 800,000,000" onkeyup="formatCurrency(this)">
                                    <span class="absolute right-4 top-2.5 text-slate-400 text-sm font-bold">VND</span>
                                </div>
                            </div>

                            <div class="flex items-center justify-between bg-slate-50 p-3 rounded-lg border border-slate-200">
                                <span class="text-sm font-medium text-slate-700">Xác định được chi phí?</span>
                                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="toggle" id="expenseToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 left-0 transition-all duration-300" onclick="toggleExpenseInput()"/>
                                    <label for="expenseToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer transition-colors duration-300"></label>
                                </div>
                            </div>

                            <div id="expenseContainer" class="hidden transition-all duration-300">
                                <label class="block text-sm font-bold text-slate-700 mb-2">Chi phí ước tính (năm)</label>
                                <div class="relative">
                                    <input type="text" id="expenseInput" class="calc-input pr-12 font-bold text-slate-800" placeholder="Ví dụ: 600,000,000" onkeyup="formatCurrency(this)">
                                    <span class="absolute right-4 top-2.5 text-slate-400 text-sm font-bold">VND</span>
                                </div>
                                <p class="text-xs text-slate-500 mt-1">Bao gồm giá vốn, chi phí quản lý, vận hành...</p>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Ngành nghề kinh doanh</label>
                                <select id="sectorInput" class="calc-input">
                                    <option value="1-0.5">Phân phối, cung cấp hàng hoá (VAT 1%, TNCN 0.5%)</option>
                                    <option value="3-1.5">Sản xuất, vận tải, xây dựng có bao thầu (VAT 3%, TNCN 1.5%)</option>
                                    <option value="5-2">Dịch vụ, xây dựng không bao thầu (VAT 5%, TNCN 2%)</option>
                                    <option value="5-5">Cho thuê tài sản, BĐS (VAT 5%, TNCN 5%)</option>
                                    <option value="5-5">Sản phẩm nội dung số (VAT 5%, TNCN 5%)</option>
                                    <option value="2-1">Các ngành nghề khác (VAT 2%, TNCN 1%)</option>
                                </select>
                            </div>

                            <button onclick="calculateTax()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg shadow transition-all active:scale-95">
                                Tính Toán Ngay
                            </button>
                        </div>

                        <!-- Result Area -->
                        <div class="bg-slate-50 rounded-xl p-5 border border-slate-200 flex flex-col justify-center relative">
                            <div id="resultPlaceholder" class="text-center text-slate-400">
                                <i class="fa-solid fa-chart-pie text-4xl mb-3 opacity-30"></i>
                                <p>Nhập số liệu để xem kết quả</p>
                            </div>
                            
                            <div id="resultContent" class="hidden space-y-4">
                                <div class="text-center pb-4 border-b border-slate-200">
                                    <p class="text-sm text-slate-500 mb-1">Phân loại:</p>
                                    <span id="groupBadge" class="inline-block px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-green-100 text-green-700">Nhóm 1 - Miễn Thuế</span>
                                </div>

                                <div id="taxDetails" class="space-y-4">
                                    
                                    <!-- VAT Section -->
                                    <div>
                                        <div class="flex justify-between items-center text-sm">
                                            <span class="text-slate-600 font-medium">Thuế GTGT (VAT):</span>
                                            <span class="font-bold text-red-600" id="vatResult">0 đ</span>
                                        </div>
                                        <div class="formula-box" id="vatFormula">
                                            ...
                                        </div>
                                    </div>

                                    <!-- TNCN Section -->
                                    <div>
                                        <div class="flex justify-between items-center text-sm">
                                            <span class="text-slate-600 font-medium">Thuế TNCN:</span>
                                            <span class="font-bold text-red-600" id="pitResult">0 đ</span>
                                        </div>
                                        <div class="formula-box" id="pitFormula">
                                            ...
                                        </div>
                                    </div>
                                    
                                    <!-- Total -->
                                    <div class="pt-3 border-t border-slate-200 flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                                        <span class="font-bold text-slate-800">TỔNG THUẾ / NĂM:</span>
                                        <span class="font-black text-2xl text-red-600" id="totalTax">0 đ</span>
                                    </div>
                                </div>
                                
                                <div class="bg-blue-50 p-3 rounded text-[11px] text-blue-800 border border-blue-100">
                                    <strong>Giải thích:</strong>
                                    <ul class="list-disc pl-3 mt-1 space-y-1">
                                        <li><strong>VAT:</strong> Tính trên toàn bộ doanh thu.</li>
                                        <li><strong>TNCN (không có chi phí):</strong> Tính trên phần doanh thu vượt 500 triệu.</li>
                                        <li><strong>TNCN (có chi phí):</strong> Tính trên Lợi nhuận = Doanh thu - Chi phí.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECTION 2 -->
            <section id="tong-quan" class="scroll-mt-24" data-aos="fade-up">
                <h2 class="text-2xl font-bold text-red-600 mb-6 flex items-center gap-2">
                    <span class="bg-red-100 w-8 h-8 flex items-center justify-center rounded-full text-sm">2</span> 
                    Tổng Quan Về Lộ Trình Thay Đổi
                </h2>
                
                <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2"><i class="fa-solid fa-flag-checkered text-red-500"></i> Chấm dứt phương pháp Thuế Khoán</h3>
                <p class="leading-relaxed mb-4 text-slate-700">
                    Theo quy định mới, phương pháp tính thuế khoán sẽ chính thức được bãi bỏ từ ngày 01/01/2026. Thay vào đó là hình thức kê khai theo doanh thu thực tế.
                </p>

                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
                    <h4 class="font-bold text-blue-800 mb-2"><i class="fa-solid fa-hand-holding-heart"></i> Hỗ trợ từ Cơ quan Thuế</h4>
                    <p class="text-sm text-slate-700">
                        Ngành thuế cam kết hỗ trợ tối đa, không đặt nặng truy thu hay xử phạt sai sót không cố ý trong giai đoạn đầu.
                    </p>
                </div>
            </section>

            <!-- SECTION 3 -->
            <section id="phan-nhom" class="scroll-mt-24" data-aos="fade-up">
                <h2 class="text-2xl font-bold text-red-600 mb-6 flex items-center gap-2">
                    <span class="bg-red-100 w-8 h-8 flex items-center justify-center rounded-full text-sm">3</span> 
                    Phân Nhóm Hộ Kinh Doanh & Ngưỡng Miễn Thuế
                </h2>
                
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-5 mb-6 rounded-r-lg shadow-sm">
                    <h3 class="text-lg font-bold text-yellow-800 mb-2 flex items-center gap-2"><i class="fa-solid fa-star"></i> Tin vui: Nâng ngưỡng doanh thu miễn thuế</h3>
                    <p class="text-slate-700">
                        Từ 01/01/2026, các Hộ Kinh Doanh có tổng doanh thu trong năm từ <strong>500 triệu đồng trở xuống</strong> sẽ được <strong>miễn nộp cả thuế GTGT và TNCN</strong>.
                    </p>
                </div>

                <div class="overflow-x-auto">
                    <table class="tax-table">
                        <thead>
                            <tr>
                                <th class="w-1/4">Nhóm Doanh Thu</th>
                                <th>Đặc Điểm & Phương Pháp Tính</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="font-bold text-red-600">Nhóm 1<br><span class="text-xs text-slate-500 font-normal">≤ 500 triệu/năm</span></td>
                                <td>• Miễn nộp thuế GTGT và TNCN.<br>• Kê khai 01 lần/năm.</td>
                            </tr>
                            <tr>
                                <td class="font-bold text-red-600">Nhóm 2<br><span class="text-xs text-slate-500 font-normal">> 500 triệu - 3 tỷ/năm</span></td>
                                <td>
                                    • <strong>Thuế GTGT:</strong> Tỷ lệ % trên doanh thu.<br>
                                    • <strong>Thuế TNCN:</strong>
                                    <ul class="list-disc pl-4 mt-1 text-xs">
                                        <li>Không xác định chi phí: Tỷ lệ % trên (Doanh thu - 500tr).</li>
                                        <li>Xác định chi phí: 15% trên Lợi nhuận.</li>
                                    </ul>
                                </td>
                            </tr>
                            <tr>
                                <td class="font-bold text-red-600">Nhóm 3<br><span class="text-xs text-slate-500 font-normal">> 3 tỷ - 50 tỷ/năm</span></td>
                                <td>
                                    • <strong>Thuế GTGT:</strong> Tỷ lệ % trên doanh thu.<br>
                                    • <strong>Thuế TNCN:</strong> 17% trên Lợi nhuận.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- SECTION 4 -->
            <section id="huong-dan-tinh-thue" class="scroll-mt-24" data-aos="fade-up">
                <h2 class="text-2xl font-bold text-red-600 mb-6 flex items-center gap-2">
                    <span class="bg-red-100 w-8 h-8 flex items-center justify-center rounded-full text-sm">4</span> 
                    Hướng Dẫn Kê Khai và Tính Thuế
                </h2>

                <div class="bg-white p-5 rounded-lg border border-slate-200 mb-6 shadow-sm">
                    <h4 class="font-bold text-slate-800 text-lg mb-3">Công thức tính thuế</h4>
                    
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div class="bg-red-50 p-4 rounded text-center">
                            <p class="text-xs uppercase font-bold text-red-400 mb-1">Thuế GTGT (Mọi trường hợp)</p>
                            <p class="font-bold text-red-800">Doanh thu x Tỷ lệ VAT ngành nghề</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded text-center">
                            <p class="text-xs uppercase font-bold text-blue-400 mb-1">Thuế TNCN (Nếu biết chi phí)</p>
                            <p class="font-bold text-blue-800">Lợi nhuận x Thuế suất (15-20%)</p>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-3 rounded text-sm text-slate-600 italic border border-slate-200">
                        <strong>Lưu ý về TNCN (trường hợp không xác định chi phí):</strong> Công thức là (Doanh thu - 500 triệu) x Tỷ lệ TNCN ngành nghề.
                    </div>
                </div>

                <!-- KiotViet Solution -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-5 rounded-xl border border-blue-100 shadow-sm">
                    <h4 class="font-bold text-blue-800 mb-3 flex items-center gap-2">
                        <img src="https://cdn-icons-png.flaticon.com/512/2885/2885430.png" class="w-6 h-6" alt="Icon">
                        Giải pháp Kê khai tự động cùng KiotViet
                    </h4>
                    <ul class="space-y-2 text-sm text-slate-700">
                        <li class="flex items-start gap-2"><i class="fa-solid fa-check text-green-500 mt-1"></i> Tự động tổng hợp doanh thu/chi phí, lập tờ khai mẫu 01/CNKD.</li>
                        <li class="flex items-start gap-2"><i class="fa-solid fa-check text-green-500 mt-1"></i> Quản lý chi phí không hóa đơn (lập Bảng kê thu mua dễ dàng).</li>
                        <li class="flex items-start gap-2"><i class="fa-solid fa-check text-green-500 mt-1"></i> Kết nối nộp tờ khai trực tuyến qua cổng Thuế điện tử.</li>
                    </ul>
                </div>
            </section>

            <!-- SECTION 5 -->
            <section id="hoa-don-so-sach" class="scroll-mt-24" data-aos="fade-up">
                <h2 class="text-2xl font-bold text-red-600 mb-6 flex items-center gap-2">
                    <span class="bg-red-100 w-8 h-8 flex items-center justify-center rounded-full text-sm">5</span> 
                    Hóa Đơn Điện Tử & Sổ Sách Kế Toán
                </h2>

                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <h4 class="font-bold text-slate-800 mb-2">Quy định về Hóa đơn điện tử</h4>
                        <ul class="list-disc pl-5 text-sm text-slate-700 space-y-2">
                            <li><strong>Doanh thu ≥ 1 tỷ:</strong> Bắt buộc sử dụng HĐĐT thường xuyên.</li>
                            <li><strong>Doanh thu < 1 tỷ:</strong> Phải xuất hóa đơn khi khách yêu cầu.</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold text-slate-800 mb-2">Sổ sách & Chứng từ</h4>
                        <ul class="list-disc pl-5 text-sm text-slate-700 space-y-2">
                            <li>Phải ghi chép sổ sách theo <strong>Thông tư 88/2021/TT-BTC</strong>.</li>
                            <li><strong>Chi phí không hóa đơn:</strong> Lập Bảng kê thu mua.</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- SECTION 6 -->
            <section id="rui-ro" class="scroll-mt-24" data-aos="fade-up">
                <h2 class="text-2xl font-bold text-red-600 mb-6 flex items-center gap-2">
                    <span class="bg-red-100 w-8 h-8 flex items-center justify-center rounded-full text-sm">6</span> 
                    Nhận Diện Rủi Ro Pháp Lý
                </h2>

                <div class="overflow-x-auto mb-6">
                    <table class="tax-table">
                        <thead>
                            <tr>
                                <th>Hành Vi Vi Phạm</th>
                                <th>Mức Phạt Tham Khảo</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Chậm nộp tờ khai thuế</td>
                                <td>Cảnh cáo hoặc 2 - 25 triệu đồng</td>
                            </tr>
                            <tr>
                                <td>Không lập hóa đơn khi bán</td>
                                <td>10 - 20 triệu đồng (nguy cơ bị coi là trốn thuế)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
        </article>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-slate-200 py-8 mt-10">
        <div class="max-w-6xl mx-auto px-4 text-center">
            <p class="text-slate-500 font-medium text-sm">Learning and Development Department</p>
            <p class="text-slate-400 text-xs mt-2">© 2026 KiotViet. All rights reserved.</p>
        </div>
    </footer>
    
    <!-- Scripts -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init();
        
        // --- Calculator Logic ---
        function formatCurrency(input) {
            let value = input.value.replace(/\D/g, '');
            if (value === '') return;
            input.value = parseInt(value).toLocaleString('en-US');
        }

        function formatMoney(amount) {
            return parseInt(amount).toLocaleString('vi-VN') + " đ";
        }

        function toggleExpenseInput() {
            const expenseContainer = document.getElementById('expenseContainer');
            const checkbox = document.getElementById('expenseToggle');
            if (checkbox.checked) {
                expenseContainer.classList.remove('hidden');
            } else {
                expenseContainer.classList.add('hidden');
                document.getElementById('expenseInput').value = '';
            }
        }

        function calculateTax() {
            // 1. Get Inputs
            const revenueStr = document.getElementById('revenueInput').value.replace(/,/g, '');
            const revenue = parseInt(revenueStr);
            const expenseStr = document.getElementById('expenseInput').value.replace(/,/g, '');
            const expense = expenseStr ? parseInt(expenseStr) : 0;
            const hasExpense = document.getElementById('expenseToggle').checked;
            const sectorValue = document.getElementById('sectorInput').value;
            
            // UI Elements
            const resultPlaceholder = document.getElementById('resultPlaceholder');
            const resultContent = document.getElementById('resultContent');
            const groupBadge = document.getElementById('groupBadge');
            const vatResultEl = document.getElementById('vatResult');
            const pitResultEl = document.getElementById('pitResult');
            const totalTaxEl = document.getElementById('totalTax');
            const vatFormulaEl = document.getElementById('vatFormula');
            const pitFormulaEl = document.getElementById('pitFormula');
            const taxDetailsEl = document.getElementById('taxDetails');

            // 2. Validation
            if (isNaN(revenue) || revenue < 0) {
                alert("Vui lòng nhập doanh thu hợp lệ!");
                return;
            }

            // 3. Logic
            resultPlaceholder.classList.add('hidden');
            resultContent.classList.remove('hidden');

            const THRESHOLD = 500000000; // 500 mil

            if (revenue <= THRESHOLD) {
                // Group 1
                groupBadge.className = "inline-block px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-green-100 text-green-700";
                groupBadge.textContent = "Nhóm 1 - Miễn Thuế";
                
                vatResultEl.textContent = "0 đ";
                pitResultEl.textContent = "0 đ";
                totalTaxEl.textContent = "0 đ";
                
                vatFormulaEl.innerHTML = "Doanh thu (" + formatMoney(revenue) + ") ≤ 500tr => <strong>Miễn VAT</strong>";
                pitFormulaEl.innerHTML = "Doanh thu (" + formatMoney(revenue) + ") ≤ 500tr => <strong>Miễn TNCN</strong>";
                
                taxDetailsEl.classList.add('opacity-70');
            } else {
                // Group 2 or 3
                groupBadge.className = "inline-block px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-blue-100 text-blue-700";
                groupBadge.textContent = revenue > 3000000000 ? "Nhóm 3 - Phải Kê Khai (Tháng/Quý)" : "Nhóm 2 - Phải Kê Khai (Quý)";
                taxDetailsEl.classList.remove('opacity-70');

                // Rates
                const [vatRateRatio, pitRateRatio] = sectorValue.split('-').map(Number);
                const vatRate = vatRateRatio / 100;
                const pitRate = pitRateRatio / 100;

                // --- VAT Calculation ---
                // VAT is calculated on FULL revenue (current interpretation of the guide)
                const vatAmount = revenue * vatRate;
                vatFormulaEl.innerHTML = `${formatMoney(revenue)} x ${vatRateRatio}% = <strong>${formatMoney(vatAmount)}</strong>`;

                // --- TNCN Calculation ---
                let pitAmount = 0;
                
                if (hasExpense) {
                    // Method: Profit
                    const profit = revenue - expense;
                    
                    if (profit > 0) {
                        let profitTaxRate = 0.15; // Default < 3B
                        let rateDisplay = "15%";
                        
                        if (revenue > 50000000000) { profitTaxRate = 0.20; rateDisplay = "20%"; }
                        else if (revenue > 3000000000) { profitTaxRate = 0.17; rateDisplay = "17%"; }
                        
                        pitAmount = profit * profitTaxRate;
                        
                        pitFormulaEl.innerHTML = `Lợi nhuận (${formatMoney(profit)}) x ${rateDisplay} = <strong>${formatMoney(pitAmount)}</strong><br><span class='text-[10px] italic text-slate-500'>(Lợi nhuận = ${formatMoney(revenue)} - ${formatMoney(expense)})</span>`;
                    } else {
                        pitAmount = 0;
                        pitFormulaEl.innerHTML = `Lợi nhuận (${formatMoney(profit)}) ≤ 0 => <strong>Không nộp TNCN</strong>`;
                    }
                } else {
                    // Method: Revenue Ratio (with threshold deduction)
                    const taxableRevenueForPIT = revenue - THRESHOLD;
                    if (taxableRevenueForPIT > 0) {
                        pitAmount = taxableRevenueForPIT * pitRate;
                        pitFormulaEl.innerHTML = `(${formatMoney(revenue)} - 500tr) x ${pitRateRatio}% = <strong>${formatMoney(pitAmount)}</strong>`;
                    } else {
                         // Should not happen here as we checked revenue <= threshold earlier, but for safety
                        pitAmount = 0;
                        pitFormulaEl.innerHTML = "Doanh thu chưa vượt ngưỡng chịu thuế TNCN";
                    }
                }

                const totalAmount = vatAmount + pitAmount;

                // Update UI Numbers
                vatResultEl.textContent = formatMoney(vatAmount);
                pitResultEl.textContent = formatMoney(pitAmount);
                totalTaxEl.textContent = formatMoney(totalAmount);
            }
        }

        // --- TOC Logic ---
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.getAttribute('id');
                    document.querySelectorAll('.toc-link').forEach(link => {
                        link.classList.remove('active');
                        if (link.getAttribute('href') === `#${id}`) link.classList.add('active');
                    });
                }
            });
        }, { rootMargin: '-20% 0px -60% 0px' });
        document.querySelectorAll('section').forEach(section => observer.observe(section));
    </script>
</body>
</html>
