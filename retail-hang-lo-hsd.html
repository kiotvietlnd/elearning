<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KiotViet Training - Quản lý Lô Hạn sử dụng</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;700&family=Nunito:wght@400;700&display=swap" rel="stylesheet">

    <!-- Confetti JS -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body {
            font-family: 'Lexend', sans-serif;
            background-color: #f0f4f8;
            overflow-x: hidden;
        }

        /* 3D Flip Card Styles */
        .perspective-1000 { perspective: 1000px; }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            cursor: pointer;
        }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .flip-card-back {
            background-color: #00558F; /* KiotViet Blue */
            color: white;
            transform: rotateY(180deg);
        }

        /* Dynamic Background Patterns - Retail Vibes */
        .bg-retail-1 { background-image: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .bg-retail-2 { background-image: linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%); }
        .bg-retail-3 { background-image: linear-gradient(to top, #accbee 0%, #e7f0fd 100%); }
        .bg-retail-4 { background-image: linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%); }
        .bg-retail-5 { background-image: linear-gradient(120deg, #fccb90 0%, #d57eeb 100%); }
        .bg-retail-master { background-image: linear-gradient(to right, #43e97b 0%, #38f9d7 100%); }

        /* KiotViet Colors */
        .text-kiot-blue { color: #00558F; }
        .bg-kiot-blue { background-color: #00558F; }
        .bg-kiot-green { background-color: #4CAF50; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .hidden-text {
            background: #e2e8f0;
            color: transparent;
            border-radius: 4px;
            user-select: none;
        }

        /* Highlight Active Line */
        .dialogue-active {
            border: 2px solid #00558F !important;
            background-color: #e0f2fe !important;
            transform: scale(1.02);
            transition: all 0.3s ease;
        }

        /* Modal Styles */
        .modal {
            transition: opacity 0.25s ease;
        }
        body.modal-active {
            overflow-x: hidden;
            overflow-y: hidden !important;
        }

        /* Certificate Styles */
        .certificate-border {
            border: 8px solid #00558F;
            padding: 5px;
            position: relative;
            background: #fff;
        }
        .certificate-inner {
            border: 2px dashed #4CAF50;
            padding: 20px;
            text-align: center;
            background: url('https://www.transparenttextures.com/patterns/cream-paper.png');
        }
        
        /* Floating Button Animation */
        .float-btn {
            transition: transform 0.2s;
        }
        .float-btn:hover {
            transform: scale(1.1);
        }
        .float-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="h-screen flex flex-col text-slate-800">

    <!-- Header -->
    <header class="bg-white shadow-md p-3 flex justify-between items-center z-20 sticky top-0">
        <div class="flex items-center gap-4">
            <!-- Logo KiotViet with Link -->
            <a href="https://kiotvietlnd.github.io/elearning" target="_blank" title="Về trang chủ Elearning">
                <img src="https://logo.kiotviet.vn/KiotViet-Logo-Horizontal.svg" alt="KiotViet Logo" class="h-8 md:h-10 object-contain hover:opacity-80 transition-opacity">
            </a>
            
            <div class="hidden md:block border-l border-gray-300 pl-4">
                <h1 class="font-bold text-xl text-kiot-blue uppercase tracking-wide">Quản lý Lô - Hạn sử dụng</h1>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <!-- Industry Badge (Blue for Retail) -->
            <div class="hidden md:flex items-center gap-2 px-3 py-1 bg-blue-50 text-blue-700 rounded-full border border-blue-200 shadow-sm">
                <i class="fa-solid fa-shop"></i>
                <span class="font-bold text-sm">Ngành Bán buôn, Bán lẻ</span>
            </div>
            <!-- Mobile Icon only -->
            <div class="md:hidden text-blue-600 text-xl">
                <i class="fa-solid fa-shop"></i>
            </div>
        </div>
    </header>

    <!-- Mobile Title -->
    <div class="md:hidden bg-white border-b p-2 text-center shadow-sm z-10">
        <h1 class="font-bold text-sm text-kiot-blue uppercase">Quản lý Lô - Hạn sử dụng</h1>
    </div>

    <!-- Main Content -->
    <main id="app-container" class="flex-1 overflow-y-auto p-4 md:p-6 relative bg-retail-1 transition-all duration-700">
        
        <!-- View: Menu -->
        <div id="menu-view" class="max-w-5xl mx-auto animate__animated animate__fadeIn pb-10">
            
            <!-- Welcome Banner -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-2xl p-6 text-white mb-8 shadow-lg flex items-center justify-between relative overflow-hidden">
                <div class="z-10 max-w-2xl">
                    <h2 class="text-3xl font-bold mb-3">Chào mừng bạn!</h2>
                    <p class="opacity-95 text-lg leading-relaxed">
                        Đây là ứng dụng giúp bạn ôn tập kiến thức sản phẩm KiotViet 
                        <span class="font-bold">Ngành hàng Bán buôn, Bán lẻ</span> 
                        thông qua hội thoại, tìm hiểu thuật ngữ và làm bài trắc nghiệm ôn tập nhanh chóng và vui vẻ!
                    </p>
                </div>
                <!-- Banner Icon -->
                <div class="absolute right-6 top-1/2 transform -translate-y-1/2 text-white opacity-20 text-8xl pointer-events-none">
                    <i class="fa-solid fa-boxes-stacked"></i>
                </div>
                <!-- Decoration Circle -->
                <div class="absolute -right-10 -bottom-20 w-60 h-60 bg-white opacity-10 rounded-full"></div>
            </div>

            <h2 class="text-xl font-bold mb-4 text-slate-700 border-l-4 border-kiot-green pl-3">Danh sách bài học</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4" id="scenario-grid"></div>

            <!-- Comprehensive Lesson Block -->
            <div onclick="loadComprehensiveLesson()" class="mt-6 bg-gradient-to-r from-emerald-500 to-teal-600 rounded-xl p-6 shadow-md hover:shadow-xl transition-all cursor-pointer transform hover:-translate-y-1 group">
                <div class="flex items-center gap-5">
                    <div class="w-16 h-16 rounded-full bg-white/20 flex items-center justify-center text-white text-3xl shadow-inner group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-graduation-cap"></i>
                    </div>
                    <div class="text-white">
                        <h3 class="font-bold text-2xl">Bài học tổng hợp & Cấp chứng chỉ</h3>
                        <p class="text-emerald-100 text-sm">Ôn tập toàn bộ 5 chủ đề và làm bài kiểm tra cuối khóa.</p>
                    </div>
                    <div class="ml-auto text-white/80">
                        <i class="fa-solid fa-play text-2xl group-hover:text-white"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- View: Learning -->
        <div id="learning-view" class="hidden max-w-4xl mx-auto pb-32 animate__animated animate__fadeInRight">
            
            <!-- Top Controls Row -->
            <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                <button onclick="goBack()" class="text-slate-600 hover:text-blue-600 font-bold flex items-center gap-2 transition-colors bg-white px-4 py-2 rounded-lg shadow-sm">
                    <i class="fa-solid fa-arrow-left"></i> Trang chủ
                </button>

                <!-- Lesson Dropdown -->
                <div class="flex items-center gap-2 bg-white px-3 py-2 rounded-lg shadow-sm flex-1 max-w-xs">
                    <i class="fa-solid fa-list-ul text-slate-400"></i>
                    <select id="lesson-selector" onchange="switchLessonFromDropdown(this.value)" class="w-full bg-transparent text-slate-700 font-semibold focus:outline-none cursor-pointer">
                        <!-- Options injected via JS -->
                    </select>
                </div>
            </div>

            <!-- Top Navigation (New) -->
            <div id="lesson-navigation-top" class="mb-4 flex justify-between items-center hidden">
                <!-- Injected via JS -->
            </div>

            <div class="bg-white/95 backdrop-blur rounded-2xl p-6 shadow-lg mb-6 border-t-4 border-kiot-blue">
                <div class="flex items-center justify-between mb-2">
                    <h2 id="lesson-title" class="text-2xl font-bold text-slate-800">Lesson Title</h2>
                    <i id="lesson-icon" class="fa-solid fa-star text-2xl text-yellow-500"></i>
                </div>
                <p id="lesson-context" class="text-slate-500 italic">Context description goes here...</p>
            </div>

            <!-- Tabs -->
            <div class="flex gap-2 mb-6 justify-center bg-slate-100 p-1 rounded-full w-fit mx-auto">
                <button onclick="switchTab('dialogue')" id="btn-tab-dialogue" class="px-5 py-2 rounded-full font-bold transition-all">Hội thoại</button>
                <button onclick="switchTab('vocab')" id="btn-tab-vocab" class="px-5 py-2 rounded-full font-bold transition-all">Thuật ngữ</button>
                <button onclick="switchTab('quiz')" id="btn-tab-quiz" class="px-5 py-2 rounded-full font-bold transition-all">Kiểm tra</button>
            </div>

            <!-- Content Area -->
            <div id="content-dialogue" class="space-y-4">
                <div class="flex justify-end gap-2 mb-2">
                    <!-- Play All Button (Inline) -->
                    <button id="btn-play-all" onclick="togglePlayAll()" class="text-xs bg-indigo-50 text-indigo-700 border border-indigo-200 px-3 py-1.5 rounded-full font-bold hover:bg-indigo-100 transition-all flex items-center gap-2">
                        <i class="fa-solid fa-circle-play text-lg"></i> <span>Nghe hội thoại</span>
                    </button>
                </div>
                <div id="dialogue-container" class="space-y-5"></div>
            </div>

            <div id="content-vocab" class="hidden grid grid-cols-2 md:grid-cols-3 gap-4"></div>

            <div id="content-quiz" class="hidden space-y-6">
                <!-- Quiz container will be injected here -->
            </div>

            <!-- Bottom Navigation -->
            <div id="lesson-navigation-bottom" class="mt-8 pt-6 border-t border-slate-200 flex justify-between items-center hidden">
                <!-- Injected via JS -->
            </div>

        </div>
    </main>

    <!-- Floating Controls (Visible in Learning View) -->
    <div id="floating-controls" class="fixed bottom-24 right-4 flex flex-col gap-3 z-40 hidden transition-all duration-300 animate__animated animate__fadeInRight">
        <button onclick="scrollToTop()" class="float-btn w-12 h-12 bg-white rounded-full shadow-lg text-slate-500 hover:text-kiot-blue flex items-center justify-center border border-slate-100" title="Lên đầu trang">
            <i class="fa-solid fa-arrow-up text-lg"></i>
        </button>
        <button onclick="togglePlayAll()" class="float-btn w-12 h-12 bg-kiot-blue rounded-full shadow-lg text-white hover:bg-blue-700 flex items-center justify-center border border-blue-500" title="Bật/Dừng đọc">
            <i class="fa-solid fa-play text-lg" id="float-play-icon"></i>
        </button>
        <button onclick="replayAll()" class="float-btn w-12 h-12 bg-white rounded-full shadow-lg text-slate-500 hover:text-green-600 flex items-center justify-center border border-slate-100" title="Nghe lại từ đầu">
            <i class="fa-solid fa-rotate-left text-lg"></i>
        </button>
        <button onclick="goBack()" class="float-btn w-12 h-12 bg-white rounded-full shadow-lg text-slate-500 hover:text-red-500 flex items-center justify-center border border-slate-100" title="Về trang chủ">
            <i class="fa-solid fa-house text-lg"></i>
        </button>
    </div>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 py-4 px-4 mt-auto z-20 shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
        <div class="max-w-5xl mx-auto flex flex-col md:flex-row justify-between items-center text-xs md:text-sm text-slate-500 gap-2">
            <div>
                <a href="https://kiotvietlnd.github.io/elearning" target="_blank" class="font-semibold text-kiot-blue hover:underline hover:text-blue-700 transition-colors">
                    KiotViet - Learning and Development Department
                </a>
            </div>
            <div class="flex gap-4">
                <a href="https://www.kiotviet.vn/ho-tro" target="_blank" class="hover:text-blue-600 transition-colors flex items-center gap-1">
                    <i class="fa-solid fa-globe"></i> Website HDSD
                </a>
                <a href="https://www.youtube.com/@HDSDPhanmemKiotViet" target="_blank" class="hover:text-red-600 transition-colors flex items-center gap-1">
                    <i class="fa-brands fa-youtube"></i> Kênh YouTube
                </a>
            </div>
        </div>
    </footer>

    <!-- Certificate Modal -->
    <div id="certificate-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[60]">
        <div class="modal-overlay absolute w-full h-full bg-slate-900 opacity-70" onclick="toggleModal('certificate-modal')"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-2xl mx-auto rounded-lg shadow-2xl z-[70] overflow-hidden animate__animated animate__zoomIn">
            <div class="certificate-border m-2">
                <div class="certificate-inner">
                    <div class="flex justify-center mb-4">
                        <img src="https://logo.kiotviet.vn/KiotViet-Logo-Horizontal.svg" alt="Logo" class="h-12">
                    </div>
                    <h1 class="text-3xl font-bold text-kiot-blue mb-2 uppercase" style="font-family: 'Times New Roman', serif;">Giấy Chứng Nhận</h1>
                    <p class="text-lg text-slate-600 mb-6 italic">Learning and Development Department trân trọng ghi nhận:</p>
                    
                    <div class="text-2xl font-bold text-slate-800 mb-6 pb-2 border-b-2 border-slate-300 inline-block px-10">
                        NHÂN VIÊN KIOTVIET
                    </div>
                    
                    <p class="text-slate-600 mb-2">Đã hoàn thành xuất sắc khóa đào tạo:</p>
                    <h2 class="text-xl font-bold text-green-600 mb-8 uppercase">QUẢN LÝ HÀNG HÓA THEO LÔ - HẠN SỬ DỤNG</h2>
                    
                    <div class="flex justify-between items-end mt-8 px-10">
                        <div class="text-center">
                            <div class="w-24 h-24 bg-cover bg-center mx-auto opacity-80" style="background-image: url('https://cdn-icons-png.flaticon.com/512/2912/2912761.png');"></div>
                        </div>
                        <div class="text-center">
                            <p class="text-sm font-bold text-slate-400 mb-4">Ngày hoàn thành</p>
                            <p class="text-md font-bold text-slate-700" id="cert-date">25/12/2025</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 p-4 flex justify-center">
                <button onclick="toggleModal('certificate-modal')" class="bg-kiot-blue hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105">
                    Đóng & Hoàn thành
                </button>
            </div>
        </div>
    </div>

    <!-- Script -->
    <script>
        // --- DATA SOURCE ---
        const rawAppData = [
            // ... (Data structure same as before)
            {
                id: 0,
                title: "1. Giới thiệu chung",
                icon: "fa-solid fa-calendar-days",
                bgClass: "bg-retail-1",
                context: "Nỗi đau hàng hết hạn và giải pháp của KiotViet.",
                dialogue: [
                    { id: '1-1', speaker: 'Anh Thắng', target: "Chán quá Sơn ạ! Anh đang dọn kho thì lôi ra được cả đống sữa nhập từ năm ngoái, bị lấp ở trong cùng nên không ai để ý. Giờ lôi ra thì hết hạn cả tháng rồi. Mất toi mấy triệu bạc!", phonetic: "Nỗi đau", native: "Hàng tồn kho hết hạn" },
                    { id: '1-2', speaker: 'Sơn (KiotViet)', target: "Ôi tiếc quá anh ơi! Đây chính là lúc anh cần dùng ngay tính năng 'Quản lý Lô - Hạn sử dụng' của KiotViet rồi. Nó sinh ra để giải quyết đúng bài toán 'hàng hết hạn' này cho ngành Mẹ & Bé và Tạp hóa đấy ạ.", phonetic: "Giải pháp", native: "Giới thiệu tính năng" },
                    { id: '1-3', speaker: 'Anh Thắng', target: "Tính năng đấy cụ thể giúp được gì hả em? Anh chỉ sợ nó phức tạp quá nhân viên anh không làm được thôi.", phonetic: "Lo lắng", native: "Sợ khó sử dụng" },
                    { id: '1-4', speaker: 'Sơn (KiotViet)', target: "Đơn giản lắm anh, không khó đâu ạ. Nó mang lại 3 lợi ích 'vàng': Một là Kiểm soát minh bạch. Hai là Nguyên tắc FEFO (Hết hạn trước - Xuất trước). Ba là Cảnh báo thông minh.", phonetic: "Lợi ích", native: "3 lợi ích chính" },
                    { id: '1-5', speaker: 'Anh Thắng', target: "Nghe hợp lý đấy. Cái 'Hết hạn trước xuất trước' đúng là cái anh đang cần nhất. Triển khai luôn đi em!", phonetic: "Đồng ý", native: "Chốt triển khai" }
                ],
                vocab: [
                    { target: 'FEFO', phonetic: 'Nguyên tắc', type: 'Thuật ngữ', native: 'First Expired - First Out: Hết hạn trước thì Xuất trước' },
                    { target: 'Kiểm soát minh bạch', phonetic: 'Lợi ích', type: 'Quản lý', native: 'Biết rõ hàng thuộc lô nào, nhập ngày nào' },
                    { target: 'Cảnh báo thông minh', phonetic: 'Tính năng', type: 'Giao diện', native: 'Hiển thị màu sắc (Vàng/Đỏ) để cảnh báo date' }
                ],
                quiz: [
                    {
                        question: "Nguyên tắc FEFO trong quản lý kho nghĩa là gì?",
                        options: ["Nhập trước xuất trước", "Hết hạn trước xuất trước", "Hàng mới nhất xuất trước"],
                        answer: 1
                    },
                    {
                        question: "Ba lợi ích chính của tính năng Quản lý Lô - Hạn sử dụng là gì?",
                        options: ["Tăng giá bán, Giảm chi phí, Tăng khách hàng", "Kiểm soát minh bạch, Tối ưu xuất kho (FEFO), Cảnh báo thông minh", "Tự động nhập hàng, Tự động bán hàng, Tự động báo cáo"],
                        answer: 1
                    },
                    {
                        question: "Khi hàng hóa đã hết hạn sử dụng, hệ thống cảnh báo màu gì?",
                        options: ["Màu Xanh", "Màu Vàng", "Màu Đỏ"],
                        answer: 2
                    }
                ]
            },
            {
                id: 1,
                title: "2. Thao tác cơ bản",
                icon: "fa-solid fa-sliders",
                bgClass: "bg-retail-2",
                context: "Thiết lập, thêm hàng và bán hàng theo nguyên tắc FEFO.",
                dialogue: [
                    { id: '2-1', speaker: 'Anh Thắng', target: "Sơn ơi, hôm nay anh có lô 'Sữa bột Alpha' mới về, anh muốn quản lý đát (date) cho nó trên phần mềm thì thao tác thế nào trên máy tính?", phonetic: "Nhu cầu", native: "Quản lý date hàng mới" },
                    { id: '2-2', speaker: 'Sơn (KiotViet)', target: "Dạ, đầu tiên anh vào Thiết lập -> Hàng hóa -> Bật nút 'Quản lý tồn kho theo Lô, hạn sử dụng' lên giúp em nhé.", phonetic: "Bước 1", native: "Bật tính năng" },
                    { id: '2-3', speaker: 'Anh Thắng', target: "Rồi, anh bật xanh lên rồi. Giờ thêm hàng mới thì sao?", phonetic: "Thực hành", native: "Thêm hàng mới" },
                    { id: '2-4', speaker: 'Sơn (KiotViet)', target: "Anh vào Danh sách hàng hóa, bấm Thêm mới. Khi điền thông tin, quan trọng nhất là anh tích vào ô 'Quản lý theo lô, hạn sử dụng' ở phía dưới ạ.", phonetic: "Lưu ý", native: "Kích hoạt trên sản phẩm" },
                    { id: '2-5', speaker: 'Anh Thắng', target: "Tích rồi nhưng anh chưa thấy chỗ điền số lượng và ngày hết hạn?", phonetic: "Thắc mắc", native: "Không thấy chỗ nhập date" },
                    { id: '2-6', speaker: 'Sơn (KiotViet)', target: "Bước đó chỉ là định nghĩa thôi ạ. Muốn có số lượng và hạn dùng, anh phải tạo Phiếu Nhập Hàng. Tại phiếu nhập, anh bấm 'Thêm mới lô, hạn sử dụng' rồi điền chi tiết: Lô A01, Hạn 30/12, Số lượng 50 hộp là xong ạ.", phonetic: "Giải thích", native: "Tạo phiếu nhập để thêm tồn kho" },
                    { id: '2-7', speaker: 'Anh Thắng', target: "Ok đã hiểu. Thế lúc bán hàng thì máy nó chạy thế nào?", phonetic: "Hỏi", native: "Cơ chế bán hàng" },
                    { id: '2-8', speaker: 'Sơn (KiotViet)', target: "Giả sử anh có 2 lô: Lô A date tháng 6 và Lô B date tháng 12. Khi bán, máy sẽ tự động chọn Lô A date tháng 6 cho anh theo nguyên tắc FEFO (Hết hạn trước xuất trước).", phonetic: "FEFO", native: "Máy tự chọn date gần nhất" }
                ],
                vocab: [
                    { target: 'Thiết lập', phonetic: 'Menu', type: 'Hệ thống', native: 'Nơi bật/tắt các tính năng của cửa hàng' },
                    { target: 'Phiếu Nhập Hàng', phonetic: 'Nghiệp vụ', type: 'Kho', native: 'Nơi ghi nhận số lượng và hạn sử dụng cụ thể' },
                    { target: 'Định nghĩa hàng hóa', phonetic: 'Khái niệm', type: 'Thao tác', native: 'Tạo mã hàng trước khi nhập kho' }
                ],
                quiz: [
                    {
                        question: "Bước đầu tiên để sử dụng tính năng Lô - Hạn sử dụng là gì?",
                        options: ["Tạo phiếu nhập hàng ngay", "Vào Thiết lập -> Hàng hóa để bật tính năng", "Vào Báo cáo kiểm tra"],
                        answer: 1
                    },
                    {
                        question: "Khi tạo hàng hóa mới, bạn cần tích vào ô nào?",
                        options: ["Hàng hóa serial/IMEI", "Quản lý theo lô, hạn sử dụng", "Tích điểm khách hàng"],
                        answer: 1
                    },
                    {
                        question: "Để nhập số lượng và hạn sử dụng cụ thể cho lô hàng mới, bạn cần làm gì?",
                        options: ["Điền ngay tại màn hình tạo hàng hóa", "Tạo Phiếu Nhập Hàng", "Vào màn hình Bán hàng"],
                        answer: 1
                    },
                    {
                        question: "Nguyên tắc máy tự động chọn lô khi bán hàng là gì?",
                        options: ["Chọn lô mới nhập nhất", "Chọn lô có số lượng nhiều nhất", "Chọn lô sắp hết hạn nhất (FEFO)"],
                        answer: 2
                    }
                ]
            },
            {
                id: 2,
                title: "3. Thao tác nâng cao",
                icon: "fa-solid fa-chart-pie",
                bgClass: "bg-retail-3",
                context: "Xử lý Trả hàng, Xuất hủy và xem Báo cáo.",
                dialogue: [
                    { id: '3-1', speaker: 'Anh Thắng', target: "Sơn này, bán hàng thì anh rõ rồi. Nhưng nhỡ khách mua về xong mang trả lại thì sao? Lúc đấy nhập lại kho có bị lẫn lộn lô nọ sang lô kia không?", phonetic: "Lo lắng", native: "Xử lý hàng trả lại" },
                    { id: '3-2', speaker: 'Sơn (KiotViet)', target: "Anh yên tâm. Khi làm phiếu Trả hàng, anh chọn đúng cái lô mà khách trả lại. Hệ thống sẽ cộng ngược lại vào đúng lô đó, giá vốn lô đó cũng được cập nhật chuẩn xác luôn ạ.", phonetic: "Giải đáp", native: "Trả về đúng lô xuất" },
                    { id: '3-3', speaker: 'Anh Thắng', target: "Thế còn trường hợp anh phát hiện hàng trong kho đã hỏng hoặc hết hạn, muốn bỏ đi thì trừ kho thế nào?", phonetic: "Xử lý", native: "Hàng hư hỏng/hết hạn" },
                    { id: '3-4', speaker: 'Sơn (KiotViet)', target: "Trường hợp đó anh làm phiếu Xuất hủy giúp em. Anh chọn đúng cái lô hết hạn đó rồi bấm hủy. Kho sẽ trừ đi số lượng tương ứng để khớp với sổ sách.", phonetic: "Thao tác", native: "Tạo phiếu Xuất hủy" },
                    { id: '3-5', speaker: 'Anh Thắng', target: "À còn một việc nữa, làm sao anh biết tháng tới có những hàng nào sắp hết date để anh chạy khuyến mãi?", phonetic: "Nhu cầu", native: "Lên kế hoạch xả hàng" },
                    { id: '3-6', speaker: 'Sơn (KiotViet)', target: "Anh chỉ cần 1 click thôi. Anh vào mục Phân tích -> Hàng hóa. Ở phần 'Mối quan tâm', anh chọn 'Hạn sử dụng'. Nó sẽ liệt kê hết danh sách hàng sắp hết date để anh chủ động xả hàng ạ.", phonetic: "Báo cáo", native: "Xem danh sách sắp hết date" }
                ],
                vocab: [
                    { target: 'Trả hàng', phonetic: 'Nghiệp vụ', type: 'Kho', native: 'Nhận hàng khách trả, cộng lại vào lô cũ' },
                    { target: 'Xuất hủy', phonetic: 'Nghiệp vụ', type: 'Kho', native: 'Xóa hàng hỏng/hết hạn khỏi kho' },
                    { target: 'Báo cáo Hạn sử dụng', phonetic: 'Phân tích', type: 'Quản trị', native: 'Danh sách các lô sắp hết hạn/đã hết hạn' }
                ],
                quiz: [
                    {
                        question: "Khi khách trả lại hàng, hệ thống xử lý tồn kho thế nào?",
                        options: ["Cộng vào một lô mới tinh", "Cộng ngược lại vào đúng lô đã xuất bán", "Không cộng lại kho"],
                        answer: 1
                    },
                    {
                        question: "Để xử lý hàng đã hết hạn sử dụng cần loại bỏ khỏi kho, bạn dùng tính năng gì?",
                        options: ["Bán hàng giá 0 đồng", "Kiểm kho", "Tạo phiếu Xuất hủy"],
                        answer: 2
                    },
                    {
                        question: "Để xem danh sách hàng sắp hết date, bạn vào báo cáo nào?",
                        options: ["Phân tích -> Hàng hóa -> Mối quan tâm: Hạn sử dụng", "Báo cáo tài chính", "Báo cáo nhân viên"],
                        answer: 0
                    }
                ]
            },
            {
                id: 3,
                title: "4. Thao tác trên điện thoại",
                icon: "fa-solid fa-mobile-screen",
                bgClass: "bg-retail-4",
                context: "Nhập hàng và bán hàng tiện lợi ngay trên App.",
                dialogue: [
                    { id: '4-1', speaker: 'Anh Thắng', target: "Cửa hàng anh rộng, anh hay phải chạy loăng quăng xuống kho kiểm hàng chứ không ngồi lì ở máy tính được. Trên điện thoại có nhập được lô date này không em?", phonetic: "Nhu cầu", native: "Dùng Mobile App" },
                    { id: '4-2', speaker: 'Sơn (KiotViet)', target: "Được chứ anh. Anh mở App KiotViet Quản lý lên em chỉ cho. Khi anh Thêm mới hàng hóa hoặc Tạo phiếu nhập hàng, giao diện trên điện thoại đều có chỗ để anh điền Lô và Hạn sử dụng cảm ứng rất tiện ạ.", phonetic: "Mobile", native: "Nhập hàng trên điện thoại" },
                    { id: '4-3', speaker: 'Anh Thắng', target: "Thế còn lúc đang đứng tư vấn ở kệ hàng mà muốn tạo đơn bán luôn cho khách thì sao?", phonetic: "Tình huống", native: "Bán hàng tại kệ" },
                    { id: '4-4', speaker: 'Sơn (KiotViet)', target: "Cũng thế luôn anh. Khi anh tạo hóa đơn bán hàng trên App và chạm vào sản phẩm, màn hình sẽ hiện lên danh sách các lô đang có.", phonetic: "Hướng dẫn", native: "Chọn lô trên app" },
                    { id: '4-5', speaker: 'Anh Thắng', target: "À anh thấy rồi. Vậy là anh chỉ cần chạm vào đúng cái lô anh đang cầm trên tay và điền số lượng là xong đúng không?", phonetic: "Xác nhận", native: "Thao tác đơn giản" },
                    { id: '4-6', speaker: 'Sơn (KiotViet)', target: "Chính xác ạ. Rất tiện lợi và cơ động cho anh khi di chuyển trong cửa hàng.", phonetic: "Khẳng định", native: "Tiện lợi và cơ động" }
                ],
                vocab: [
                    { target: 'App KiotViet Quản lý', phonetic: 'Mobile', type: 'Ứng dụng', native: 'Quản lý kho, nhập hàng mọi lúc mọi nơi' },
                    { target: 'Màn hình cảm ứng', phonetic: 'Giao diện', type: 'Thiết bị', native: 'Thao tác chạm để chọn lô/date' },
                    { target: 'Cơ động', phonetic: 'Lợi ích', type: 'Mobile', native: 'Di chuyển tự do không phụ thuộc máy tính' }
                ],
                quiz: [
                    {
                        question: "Trên ứng dụng KiotViet Mobile, bạn có thể nhập lô và hạn sử dụng không?",
                        options: ["Không, chỉ xem được thôi", "Có, nhập được ngay khi tạo phiếu nhập", "Chỉ nhập được hạn sử dụng, không nhập được lô"],
                        answer: 1
                    },
                    {
                        question: "Khi bán hàng trên điện thoại, làm sao để chọn lô muốn bán?",
                        options: ["Phải nhớ mã lô để gõ vào", "Chạm vào sản phẩm, danh sách lô sẽ hiện ra để chọn", "Không chọn được, máy tự chọn ngẫu nhiên"],
                        answer: 1
                    }
                ]
            },
            {
                id: 4,
                title: "5. Thao tác trên máy POS",
                icon: "fa-solid fa-cash-register",
                bgClass: "bg-retail-5",
                context: "Tối ưu tốc độ bán hàng tại quầy thu ngân với máy POS.",
                dialogue: [
                    { id: '5-1', speaker: 'Anh Thắng', target: "Sơn ơi, cửa hàng anh lúc đông khách phải thanh toán thật nhanh. Dùng cái tính năng Lô này trên cái máy POS cảm ứng to đùng kia có làm nhân viên thao tác chậm đi không?", phonetic: "Lo lắng", native: "Tốc độ bán hàng POS" },
                    { id: '5-2', speaker: 'Sơn (KiotViet)', target: "Anh yên tâm, trên máy POS Android bên em đã tối ưu cho tốc độ rồi ạ. Nó sẽ dùng Pop-up (Cửa sổ bật lên) tự động.", phonetic: "Giải pháp", native: "Tối ưu tốc độ" },
                    { id: '5-3', speaker: 'Anh Thắng', target: "Tự động là như thế nào?", phonetic: "Thắc mắc", native: "Cơ chế tự động" },
                    { id: '5-4', speaker: 'Sơn (KiotViet)', target: "Tức là khi nhân viên tít mã vạch sản phẩm, máy POS sẽ tự động chọn sẵn lô có hạn dùng gần nhất rồi (theo nguyên tắc FEFO). Nhân viên chỉ cần bấm Xác nhận là xong, mất chưa đến 1 giây đâu anh.", phonetic: "POS", native: "Tự động gợi ý nhanh" },
                    { id: '5-5', speaker: 'Anh Thắng', target: "Thế nếu khách khó tính muốn đổi lấy lô date xa hơn thì sao?", phonetic: "Tình huống", native: "Khách đổi ý" },
                    { id: '5-6', speaker: 'Sơn (KiotViet)', target: "Lúc đó nhân viên mới cần chạm vào màn hình để chọn lại lô khác thôi ạ. Còn bình thường cứ để máy tự chọn, vừa nhanh vừa đẩy được hàng cũ đi trước.", phonetic: "Linh hoạt", native: "Chọn lại thủ công nếu cần" },
                    { id: '5-7', speaker: 'Anh Thắng', target: "Thế thì ổn. Vừa nhanh vừa đảm bảo quy trình. Cảm ơn Sơn nhé!", phonetic: "Hài lòng", native: "Đánh giá tốt" }
                ],
                vocab: [
                    { target: 'Máy POS Android', phonetic: 'Thiết bị', type: 'Phần cứng', native: 'Máy bán hàng màn hình cảm ứng chuyên dụng' },
                    { target: 'Pop-up tự động', phonetic: 'Giao diện', type: 'POS', native: 'Cửa sổ bật lên tự động gợi ý lô khi bán' },
                    { target: 'Xác nhận', phonetic: 'Thao tác', type: 'POS', native: 'Đồng ý với gợi ý của máy để bán nhanh' }
                ],
                quiz: [
                    {
                        question: "Tính năng Pop-up tự động trên máy POS có tác dụng gì?",
                        options: ["Tự động in hóa đơn", "Tự động chọn sẵn lô có hạn dùng gần nhất (FEFO)", "Tự động giảm giá"],
                        answer: 1
                    },
                    {
                        question: "Nếu khách hàng muốn chọn lô khác với lô máy gợi ý, nhân viên phải làm gì?",
                        options: ["Không đổi được", "Phải xóa sản phẩm đi quét lại", "Chạm vào màn hình để chọn lại lô khác từ danh sách"],
                        answer: 2
                    }
                ]
            }
        ];

        let appData = [...rawAppData]; 

        // --- STATE & CORE ---
        let currentScenarioId = null;
        let isPlayingAll = false;
        let correctAnswersCount = 0; 
        let currentActiveTab = 'dialogue'; // Track active tab

        function init() {
            renderMenu();
            const today = new Date();
            const dateStr = `${today.getDate()}/${today.getMonth() + 1}/${today.getFullYear()}`;
            document.getElementById('cert-date').innerText = dateStr;
        }

        function toggleModal(modalID){
            document.getElementById(modalID).classList.toggle("hidden");
            document.getElementById(modalID).classList.toggle("pointer-events-none");
            document.getElementById(modalID).classList.toggle("opacity-0");
            document.body.classList.toggle("modal-active");
            
            if(modalID === 'certificate-modal' && !document.getElementById(modalID).classList.contains('hidden')) {
                triggerConfetti();
            }
        }

        function renderMenu() {
            const grid = document.getElementById('scenario-grid');
            grid.innerHTML = rawAppData.map(item => `
                <div onclick="loadScenario(${item.id})" class="bg-white rounded-xl p-5 shadow-sm hover:shadow-md transition-all cursor-pointer border-l-4 border-blue-500 hover:scale-[1.02] flex items-center gap-4">
                    <div class="w-14 h-14 rounded-full ${item.bgClass} flex items-center justify-center text-slate-700 text-2xl shadow-inner border border-white/50">
                        <i class="${item.icon}"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-slate-800">${item.title}</h3>
                        <p class="text-sm text-slate-500 line-clamp-1">${item.context}</p>
                    </div>
                    <div class="ml-auto text-blue-400"><i class="fa-solid fa-chevron-right"></i></div>
                </div>
            `).join('');
        }

        function loadScenario(id) {
            stopPlayAll(); 
            currentScenarioId = parseInt(id);
            const data = appData[id]; 
            
            document.getElementById('menu-view').classList.add('hidden');
            document.getElementById('learning-view').classList.remove('hidden');
            
            // Show floating controls when entering lesson
            document.getElementById('floating-controls').classList.remove('hidden');
            
            const bgClass = data.bgClass || 'bg-retail-1';
            document.getElementById('app-container').className = `flex-1 overflow-y-auto p-4 md:p-6 relative transition-all duration-700 ${bgClass}`;
            
            document.getElementById('lesson-title').innerText = data.title;
            document.getElementById('lesson-icon').className = (data.icon || 'fa-solid fa-star') + " text-2xl text-yellow-500";
            document.getElementById('lesson-context').innerText = data.context || "Bài học tổng hợp";

            updateLessonDropdown(id);
            renderLessonNavigation(id); 

            renderDialogue(data.dialogue);
            renderVocab(data.vocab);
            renderQuiz(data.quiz);

            // Persist tab
            switchTab(currentActiveTab);
        }

        function loadComprehensiveLesson() {
            const combinedDialogue = rawAppData.flatMap(item => item.dialogue);
            const combinedVocab = rawAppData.flatMap(item => item.vocab);
            let combinedQuiz = [];
            rawAppData.forEach(lesson => {
                lesson.quiz.forEach(q => {
                    combinedQuiz.push({
                        ...q,
                        originalLesson: lesson.title
                    });
                });
            });

            const comprehensiveData = {
                id: 99,
                title: "Bài học Tổng hợp",
                icon: "fa-solid fa-graduation-cap",
                bgClass: "bg-retail-master",
                context: "Ôn tập toàn bộ kiến thức từ tất cả các bài học.",
                dialogue: combinedDialogue,
                vocab: combinedVocab,
                quiz: combinedQuiz
            };

            appData[99] = comprehensiveData;
            correctAnswersCount = 0; 
            loadScenario(99);
        }

        function updateLessonDropdown(currentId) {
            const selector = document.getElementById('lesson-selector');
            let html = rawAppData.map(item => `<option value="${item.id}" ${item.id == currentId ? 'selected' : ''}>${item.title}</option>`).join('');
            
            if (currentId == 99) {
                html += `<option value="99" selected>★ Bài học Tổng hợp</option>`;
            } else {
                 html += `<option value="99">★ Bài học Tổng hợp</option>`;
            }
            
            selector.innerHTML = html;
        }

        function switchLessonFromDropdown(val) {
            if (val == 99) {
                loadComprehensiveLesson();
            } else {
                loadScenario(val);
            }
        }

        // --- NAVIGATION ---
        function renderLessonNavigation(currentId) {
            const containers = ['lesson-navigation-top', 'lesson-navigation-bottom'];
            
            containers.forEach(containerId => {
                const navContainer = document.getElementById(containerId);
                navContainer.innerHTML = '';
                
                // If in Comprehensive Lesson, show Home button
                if (currentId === 99) {
                    navContainer.classList.remove('hidden');
                    navContainer.innerHTML = `
                        <div class="w-full text-center">
                            <button onclick="goBack()" class="bg-gray-100 hover:bg-gray-200 text-slate-600 font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2 mx-auto">
                                <i class="fa-solid fa-house"></i> Về trang chủ
                            </button>
                        </div>
                    `;
                    return;
                }

                const prevId = currentId - 1;
                const nextId = currentId + 1;
                const hasPrev = prevId >= 0;
                const hasNext = nextId < rawAppData.length;

                if (hasPrev || hasNext) {
                    navContainer.classList.remove('hidden');
                    let html = '';
                    
                    if (hasPrev) {
                        html += `
                            <button onclick="loadScenario(${prevId})" class="bg-white border border-slate-200 hover:border-blue-400 hover:bg-blue-50 text-slate-700 font-bold py-2 px-4 rounded-lg transition-all flex items-center gap-2 shadow-sm text-xs md:text-sm">
                                <i class="fa-solid fa-arrow-left"></i> Bài trước
                            </button>
                        `;
                    } else {
                        html += `<div></div>`; 
                    }

                    if (hasNext) {
                        html += `
                            <button onclick="loadScenario(${nextId})" class="bg-kiot-blue hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all flex items-center gap-2 shadow-md text-xs md:text-sm">
                                Bài tiếp theo <i class="fa-solid fa-arrow-right"></i>
                            </button>
                        `;
                    } else {
                        html += `
                            <button onclick="loadComprehensiveLesson()" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg transition-all flex items-center gap-2 shadow-md animate__animated animate__pulse animate__infinite text-xs md:text-sm">
                                Bài tổng hợp <i class="fa-solid fa-graduation-cap"></i>
                            </button>
                        `;
                    }
                    
                    navContainer.innerHTML = html;
                } else {
                    navContainer.classList.add('hidden');
                }
            });
        }

        function goBack() {
            stopPlayAll();
            document.getElementById('learning-view').classList.add('hidden');
            document.getElementById('menu-view').classList.remove('hidden');
            document.getElementById('floating-controls').classList.add('hidden');
            document.getElementById('app-container').className = "flex-1 overflow-y-auto p-4 md:p-6 relative bg-retail-1 transition-all duration-700";
            
            // Reset to default tab for next entry
            currentActiveTab = 'dialogue';
        }

        function scrollToTop() {
            document.getElementById('app-container').scrollTo({ top: 0, behavior: 'smooth' });
        }

        function replayAll() {
            stopPlayAll();
            setTimeout(() => {
                togglePlayAll();
            }, 300);
        }

        // --- TABS ---
        function switchTab(tabName) {
            stopPlayAll();
            currentActiveTab = tabName; // Update state
            
            ['dialogue', 'vocab', 'quiz'].forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden');
                document.getElementById(`btn-tab-${t}`).className = "px-5 py-2 rounded-full font-bold transition-all text-slate-500 hover:text-slate-700";
            });
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            const activeBtn = document.getElementById(`btn-tab-${tabName}`);
            activeBtn.className = "px-5 py-2 rounded-full font-bold transition-all bg-kiot-blue text-white shadow-md transform scale-105";
            
            const contentDiv = document.getElementById(`content-${tabName}`);
            contentDiv.classList.remove('animate__fadeIn');
            void contentDiv.offsetWidth; 
            contentDiv.classList.add('animate__animated', 'animate__fadeIn');
        }

        // --- RENDERERS ---
        function renderDialogue(dialogueList) {
            const container = document.getElementById('dialogue-container');
            container.innerHTML = dialogueList.map((line, idx) => {
                const isManager = line.speaker.includes('Sơn');
                const alignClass = isManager ? 'flex-row' : 'flex-row-reverse';
                const bgClass = isManager ? 'bg-white rounded-tl-none border-l-4 border-blue-500' : 'bg-green-100 rounded-tr-none border-r-4 border-green-500';
                const avatarIcon = isManager ? 'fa-user-tie' : 'fa-user-tag'; 
                
                const cleanTarget = line.target.replace(/'/g, "\\'");
                const character = isManager ? 'son' : 'thang';

                return `
                <div id="dialogue-line-${idx}" class="flex ${alignClass} items-start gap-3 dialogue-item group transition-all duration-300" data-speaker="${character}">
                    <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center font-bold text-slate-600 text-sm shadow-sm shrink-0">
                        <i class="fa-solid ${avatarIcon}"></i>
                    </div>
                    <div class="${bgClass} p-3 rounded-2xl shadow-sm max-w-[85%] transition-all cursor-pointer hover:shadow-md dialogue-bubble" onclick="stopPlayAll(); playSmartAudio('${cleanTarget}', '', '${character}')">
                        <p class="text-xs text-slate-400 font-bold mb-1">${line.speaker}</p>
                        <div class="flex items-center gap-2 mb-1">
                            <i class="fa-solid fa-volume-high text-blue-400 text-xs opacity-50"></i>
                            <p class="font-medium text-slate-800 text-lg target-text transition-all leading-snug">${line.target}</p>
                        </div>
                        <div class="flex justify-between items-center border-t border-black/5 pt-1 mt-1">
                            <p class="text-xs text-purple-600 font-semibold uppercase tracking-wide">${line.phonetic}</p>
                            <p class="text-slate-500 text-xs italic">${line.native}</p>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function renderVocab(vocabList) {
            const container = document.getElementById('content-vocab');
            container.innerHTML = vocabList.map(word => `
                <div class="flip-card h-56 perspective-1000" onclick="this.classList.toggle('flipped'); playSound('click')">
                    <div class="flip-card-inner">
                        <div class="flip-card-front bg-white text-slate-800 border-b-4 border-blue-500 rounded-xl shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex flex-col items-center justify-center h-full p-2">
                                <i class="fa-solid fa-tag text-blue-300 text-3xl mb-3"></i>
                                <p class="text-xl font-bold text-blue-800 text-center leading-tight mb-2">${word.target}</p>
                                <span class="text-xs px-2 py-0.5 bg-gray-100 rounded-full text-gray-500 font-mono">${word.type}</span>
                            </div>
                            <i class="fa-solid fa-rotate text-gray-300 absolute bottom-3 right-3 text-sm"></i>
                        </div>
                        <div class="flip-card-back bg-gradient-to-br from-blue-600 to-blue-800 rounded-xl">
                            <div class="flex flex-col items-center justify-center h-full p-3">
                                <p class="font-bold text-lg mb-2 text-center text-white">${word.native}</p>
                                <p class="text-sm opacity-80 italic text-center mb-4 text-blue-100">${word.phonetic}</p>
                                <button class="w-10 h-10 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center text-white backdrop-blur-sm" onclick="event.stopPropagation(); playSmartAudio('${word.target}', '', 'vocab')">
                                    <i class="fa-solid fa-volume-high"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // --- QUIZ ENGINE ---
        function renderQuiz(quizData) {
            const container = document.getElementById('content-quiz');
            container.innerHTML = ''; 

            const quizzes = Array.isArray(quizData) ? quizData : [quizData];

            quizzes.forEach((q, qIndex) => {
                const headerHtml = Array.isArray(quizData) && quizData.length > 1 
                    ? `<div class="font-bold text-slate-500 text-sm mb-2 uppercase tracking-wide">Câu hỏi ${qIndex + 1} ${q.originalLesson ? `- ${q.originalLesson}` : ''}</div>` 
                    : '';

                const qID = `quiz-${qIndex}`;
                
                const card = document.createElement('div');
                card.className = "bg-white rounded-2xl p-6 shadow-md border border-slate-100";
                card.innerHTML = `
                    ${headerHtml}
                    <div class="mb-4">
                        <h3 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-circle-question text-blue-500 mr-2"></i>${q.question}</h3>
                    </div>
                    <div class="grid gap-2" id="${qID}-options">
                        ${q.options.map((opt, i) => `
                            <button onclick="checkAnswerMulti(${qIndex}, ${i}, this)" class="w-full text-left p-3 rounded-lg border border-slate-200 hover:border-blue-400 hover:bg-blue-50 transition-all font-medium text-slate-700 text-sm option-btn">
                                <span class="inline-block w-6 h-6 rounded-full bg-slate-100 text-center text-xs leading-6 mr-2 font-bold text-slate-500">${String.fromCharCode(65+i)}</span>
                                ${opt}
                            </button>
                        `).join('')}
                    </div>
                    <div id="${qID}-feedback" class="mt-3 font-bold text-sm hidden"></div>
                `;
                container.appendChild(card);
            });
        }

        function checkAnswerMulti(qIndex, selectedOptIndex, btnElement) {
            let quizList;
            if (currentScenarioId == 99) {
                quizList = appData[99].quiz;
            } else {
                quizList = appData[currentScenarioId].quiz; 
            }
            
            const correctIndex = quizList[qIndex].answer;
            const card = btnElement.closest('.bg-white');
            const feedbackEl = card.querySelector(`div[id$="-feedback"]`);
            const allBtns = card.querySelectorAll('.option-btn');

            allBtns.forEach(b => b.disabled = true);

            if (selectedOptIndex === correctIndex) {
                playSound('success');
                btnElement.classList.remove('border-slate-200');
                btnElement.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
                
                feedbackEl.innerHTML = "<i class='fa-solid fa-check'></i> Chính xác!";
                feedbackEl.className = "mt-3 font-bold text-sm text-green-600 animate__animated animate__pulse block";
                
                if (currentScenarioId == 99) {
                    correctAnswersCount++;
                    if (correctAnswersCount === quizList.length) {
                        setTimeout(() => {
                            toggleModal('certificate-modal');
                        }, 1000);
                    }
                } else {
                    triggerConfetti(); 
                }

            } else {
                playSound('error');
                btnElement.classList.add('bg-red-50', 'border-red-400');
                
                allBtns[correctIndex].classList.add('bg-green-50', 'border-green-500');

                feedbackEl.innerHTML = "Sai rồi. Đáp án đúng: " + String.fromCharCode(65+correctIndex);
                feedbackEl.className = "mt-3 font-bold text-sm text-red-500 animate__animated animate__shakeX block";
            }
        }

        // --- PLAY ALL & VOICE ENGINE ---

        function togglePlayAll() {
            const btn = document.getElementById('btn-play-all');
            const floatIcon = document.getElementById('float-play-icon');
            
            if (isPlayingAll) {
                stopPlayAll();
            } else {
                isPlayingAll = true;
                // Update inline button
                if(btn) {
                    btn.classList.replace('text-indigo-700', 'text-red-700');
                    btn.classList.replace('bg-indigo-50', 'bg-red-50');
                    btn.classList.replace('border-indigo-200', 'border-red-200');
                    btn.querySelector('i').className = 'fa-solid fa-circle-stop text-lg';
                    btn.querySelector('span').innerText = "Dừng lại";
                }
                // Update float icon
                if(floatIcon) floatIcon.className = 'fa-solid fa-stop text-lg';
                
                playNextLine(0);
            }
        }

        function stopPlayAll() {
            isPlayingAll = false;
            if (window.speechSynthesis) window.speechSynthesis.cancel();
            
            const btn = document.getElementById('btn-play-all');
            const floatIcon = document.getElementById('float-play-icon');

            if(btn) {
                btn.classList.replace('text-red-700', 'text-indigo-700');
                btn.classList.replace('bg-red-50', 'bg-indigo-50');
                btn.classList.replace('border-red-200', 'border-indigo-200');
                btn.querySelector('i').className = 'fa-solid fa-circle-play text-lg';
                btn.querySelector('span').innerText = "Nghe hội thoại";
            }
            if(floatIcon) floatIcon.className = 'fa-solid fa-play text-lg';
            
            document.querySelectorAll('.dialogue-bubble').forEach(el => el.classList.remove('dialogue-active'));
        }

        async function playNextLine(index) {
            if (!isPlayingAll) return;

            const dialogueData = appData[currentScenarioId].dialogue;
            if (index >= dialogueData.length) {
                stopPlayAll();
                return;
            }

            document.querySelectorAll('.dialogue-bubble').forEach(el => el.classList.remove('dialogue-active'));
            const currentLineEl = document.getElementById(`dialogue-line-${index}`);
            if (currentLineEl) {
                currentLineEl.querySelector('.dialogue-bubble').classList.add('dialogue-active');
                currentLineEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            const line = dialogueData[index];
            const character = line.speaker.includes('Sơn') ? 'son' : 'thang';
            
            await playTTSPromise(line.target, character);
            
            setTimeout(() => {
                if(isPlayingAll) playNextLine(index + 1);
            }, 500);
        }

        function playSmartAudio(text, audioUrl, character) {
             playTTS(text, character);
        }

        function playTTSPromise(text, character) {
            return new Promise((resolve) => {
                if (!window.speechSynthesis) {
                    resolve();
                    return;
                }

                window.speechSynthesis.cancel();
                
                let voices = window.speechSynthesis.getVoices();
                if (voices.length === 0) {
                    setTimeout(() => {
                        window.speechSynthesis.cancel();
                         resolve();
                    }, 500);
                    return;
                }

                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'vi-VN';
                configureVoice(u, character, voices);

                u.onend = () => resolve();
                u.onerror = () => resolve();

                window.speechSynthesis.speak(u);
            });
        }

        function playTTS(text, character) {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            
            let voices = window.speechSynthesis.getVoices();
            if (voices.length === 0) {
                setTimeout(() => playTTS(text, character), 50);
                return;
            }

            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'vi-VN';
            configureVoice(u, character, voices);
            window.speechSynthesis.speak(u);
        }

        function configureVoice(u, character, voices) {
            const vnVoices = voices.filter(v => v.lang.includes('vi'));
            let selectedVoice = null;
            let pitch = 1.0;
            let rate = 1.0;

            if (character === 'vocab') {
                 selectedVoice = vnVoices.find(v => v.name.includes('Google') || v.name.includes('Linh'));
                 rate = 1.1; 
            } else if (character === 'son') {
                selectedVoice = vnVoices.find(v => v.name.includes('An') || v.name.includes('Minh') || v.name.includes('Nam'));
                if (selectedVoice) {
                    pitch = 1.1; 
                } else {
                    selectedVoice = vnVoices[0];
                    pitch = 0.95; 
                }
                rate = 1.2; 
            } else if (character === 'thang') {
                selectedVoice = vnVoices.find(v => v.name.includes('An') || v.name.includes('Minh') || v.name.includes('Nam'));
                if (selectedVoice) {
                    pitch = 0.8; 
                } else {
                    selectedVoice = vnVoices[0];
                    pitch = 0.75; 
                }
                rate = 1.05; 
            }

            if (selectedVoice) u.voice = selectedVoice;
            u.pitch = pitch;
            u.rate = rate;
        }
        
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            if (type === 'click') {
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'success') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(523, audioCtx.currentTime);
                osc.frequency.setValueAtTime(659, audioCtx.currentTime + 0.1);
                osc.frequency.setValueAtTime(784, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.5);
                osc.start(); osc.stop(audioCtx.currentTime + 0.5);
            } else if (type === 'error') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        function triggerConfetti() {
            var duration = 2500;
            var end = Date.now() + duration;
            (function frame() {
                confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
                confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
